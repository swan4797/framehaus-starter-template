---
// ========================================
// SEARCH PAGE
// Property search results with sidebar filters
// ========================================

export const prerender = false

import Layout from '../layouts/Layout.astro'
import Pagination from '../components/search/Pagination.astro'
import { searchProperties } from '../lib/api'

// Search Page Components
import SearchPageLayout from '../components/search-page/layout/SearchPageLayout.astro'
import SearchPageGrid from '../components/search-page/layout/SearchPageGrid.astro'
import SearchHero from '../components/search-page/hero/SearchHero.astro'
import SearchSidebar from '../components/search-page/sidebar/SearchSidebar.astro'
import SearchResultsHeader from '../components/search-page/results/SearchResultsHeader.astro'
import SearchResultsGrid from '../components/search-page/results/SearchResultsGrid.astro'
import SearchErrorState from '../components/search-page/states/SearchErrorState.astro'
import SearchEmptyState from '../components/search-page/states/SearchEmptyState.astro'

// Utilities and Config
import {
  parseSearchParams,
  computeSearchValues,
  defaultSortOptions,
} from '../components/search-page'

// ----------------------------------------
// PARSE SEARCH PARAMETERS
// ----------------------------------------

const searchParams = parseSearchParams(Astro.url)

// ----------------------------------------
// FETCH PROPERTIES
// ----------------------------------------

const searchResponse = await searchProperties(searchParams)

// ----------------------------------------
// COMPUTED VALUES
// ----------------------------------------

const {
  hasError,
  properties,
  total,
  totalPages,
  activeFiltersCount,
  pageTitle,
  metaDescription,
} = computeSearchValues(searchParams, searchResponse)
---

<Layout title={pageTitle} description={metaDescription}>
  <SearchPageLayout>
    <SearchHero />

    <SearchPageGrid>
      <SearchSidebar
        slot="sidebar"
        currentParams={searchParams},
      />

      <main slot="results" class="search-results">
        {hasError ? (
          <SearchErrorState />
        ) : (
          <>
            <SearchResultsHeader
              total={total}
              location={searchParams.location}
              activeFiltersCount={activeFiltersCount}
              currentSortBy={searchParams.sort_by || 'newest'}
              sortOptions={defaultSortOptions}
            />

            {properties.length === 0 ? (
              <SearchEmptyState />
            ) : (
              <>
                <SearchResultsGrid properties={properties} />

                <div class="search-pagination">
                  <Pagination
                    currentPage={searchParams.page || 1}
                    totalPages={totalPages}
                    totalResults={total}
                    searchParams={searchParams}
                  />
                </div>
              </>
            )}
          </>
        )}
      </main>
    </SearchPageGrid>
  </SearchPageLayout>
</Layout>

<style lang="scss">
  @use '../styles/variables' as *;

  .search-results {
    min-height: 500px;
    z-index: 1;
  }

  .search-pagination {
    margin-top: $spacing-12;
  }
</style>

<script>
  import '../components/search-page/scripts/search-page-client'
</script>
