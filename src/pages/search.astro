---
// File: src/pages/search.astro
// UPDATED WITH ModernSearchBar COMPONENT

export const prerender = false

import Layout from '../layouts/Layout.astro'
import ModernSearchBar from '../components/search/SearchBar.astro'
import PropertyCard from '../components/properties/PropertyCard.astro'
import Pagination from '../components/search/Pagination.astro'
import { searchProperties } from '../lib/api'
import type { PropertySearchParams } from '../types/database'

// Parse search params from URL
const searchParams: PropertySearchParams = {
  listing_type: (Astro.url.searchParams.get('listing_type') as 'sale' | 'let') || 'sale',
  location: Astro.url.searchParams.get('location') || undefined,
  postcode: Astro.url.searchParams.get('postcode') || undefined,
  min_price: Astro.url.searchParams.get('min_price') ? parseInt(Astro.url.searchParams.get('min_price')!) : undefined,
  max_price: Astro.url.searchParams.get('max_price') ? parseInt(Astro.url.searchParams.get('max_price')!) : undefined,
  beds: Astro.url.searchParams.get('beds') ? parseInt(Astro.url.searchParams.get('beds')!) : undefined,
  property_type: Astro.url.searchParams.get('property_type') as any || undefined,
  page: Astro.url.searchParams.get('page') ? parseInt(Astro.url.searchParams.get('page')!) : 1,
  limit: 20,
  sort_by: (Astro.url.searchParams.get('sort_by') as any) || 'newest',
}

// Fetch properties
const searchResponse = await searchProperties(searchParams)

const hasError = !searchResponse
const properties = searchResponse?.properties || []
const total = searchResponse?.total || 0
const totalPages = Math.ceil(total / (searchParams.limit || 20))

const listingTypeText = searchParams.listing_type === 'sale' ? 'For Sale' : 'To Rent'
const locationText = searchParams.location ? ` in ${searchParams.location}` : ''
const pageTitle = `Properties ${listingTypeText}${locationText}`
const metaDescription = `Find properties ${listingTypeText.toLowerCase()}${locationText}. ${total} properties available.`
---

<Layout title={pageTitle} description={metaDescription}>
  <div class="bg-gray-50 min-h-screen">
    <!-- Header with Search Bar -->
    <div class="search-header">
      <div class="header-background"></div>
      <div class="header-content">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          <div class="text-center mb-6">
            <h1 class="page-title">
              Find Your Perfect Property
            </h1>
            <p class="page-subtitle">
              Search thousands of properties across the UK
            </p>
          </div>

          {/* ✅ Modern Search Bar Component */}
          <ModernSearchBar currentParams={searchParams} showAdvanced={true} />
        </div>
      </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {hasError && (
        <div class="error-card">
          <svg class="error-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <h2 class="error-title">Unable to Load Properties</h2>
          <p class="error-message">Please try again later.</p>
          <a href="/search" class="error-button">Reset Search</a>
        </div>
      )}

      {!hasError && (
        <>
          <!-- Results Header -->
          <div class="results-header">
            <div class="results-info">
              <h2 class="results-count" data-results-count={total}>
                {total === 0 ? 'No properties found' : `${total.toLocaleString()} ${total === 1 ? 'property' : 'properties'}`}
              </h2>
              {searchParams.location && (
                <p class="results-location">
                  <svg class="location-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path>
                    <circle cx="12" cy="10" r="3"></circle>
                  </svg>
                  {searchParams.location}
                </p>
              )}
            </div>

            <div class="results-badge">
              <span class="badge-text">{listingTypeText}</span>
            </div>
          </div>

          <!-- No Results -->
          {properties.length === 0 && (
            <div class="no-results-card">
              <svg class="no-results-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
              </svg>
              <h3 class="no-results-title">No properties match your search</h3>
              <p class="no-results-message">
                Try adjusting your filters or search in a different area.
              </p>
              <a href="/search" class="no-results-button">Reset Search</a>
            </div>
          )}

          <!-- Property Grid -->
          {properties.length > 0 && (
            <>
              <div class="property-grid">
                {properties.map(property => (
                  <PropertyCard 
                    property={property} 
                    featured={property.is_featured}
                    source="search_results"
                  />
                ))}
              </div>

              <!-- Pagination -->
              <div class="pagination-container">
                <Pagination
                  currentPage={searchParams.page || 1}
                  totalPages={totalPages}
                  totalResults={total}
                  searchParams={searchParams}
                />
              </div>
            </>
          )}
        </>
      )}
    </div>
  </div>
</Layout>

<style>
  /* Header Styles */
  .search-header {
    position: relative;
    background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
    overflow: hidden;
  }

  .header-background {
    position: absolute;
    inset: 0;
    background-image: 
      radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
      radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.08) 0%, transparent 50%);
  }

  .header-content {
    position: relative;
    z-index: 1;
  }

  .page-title {
    font-size: clamp(1.875rem, 4vw, 2.5rem);
    font-weight: 800;
    color: white;
    margin: 0 0 0.5rem 0;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .page-subtitle {
    font-size: clamp(0.875rem, 2vw, 1.125rem);
    color: rgba(255, 255, 255, 0.9);
    margin: 0;
  }

  /* Error Card */
  .error-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid #fee2e2;
    padding: 3rem 2rem;
    text-align: center;
  }

  .error-icon {
    width: 4rem;
    height: 4rem;
    margin: 0 auto 1rem;
    color: #ef4444;
  }

  .error-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #111827;
    margin: 0 0 0.5rem 0;
  }

  .error-message {
    color: #6b7280;
    margin: 0 0 1.5rem 0;
  }

  .error-button {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    background: #2563eb;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .error-button:hover {
    background: #1d4ed8;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
  }

  /* Results Header */
  .results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .results-info {
    flex: 1;
  }

  .results-count {
    font-size: 1.5rem;
    font-weight: 700;
    color: #111827;
    margin: 0 0 0.5rem 0;
  }

  .results-location {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    color: #6b7280;
    font-size: 0.875rem;
    margin: 0;
  }

  .location-icon {
    width: 16px;
    height: 16px;
    color: #9ca3af;
  }

  .results-badge {
    padding: 0.5rem 1rem;
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    color: white;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 600;
  }

  /* No Results */
  .no-results-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    padding: 3rem 2rem;
    text-align: center;
  }

  .no-results-icon {
    width: 4rem;
    height: 4rem;
    margin: 0 auto 1rem;
    color: #9ca3af;
  }

  .no-results-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #111827;
    margin: 0 0 0.5rem 0;
  }

  .no-results-message {
    color: #6b7280;
    margin: 0 0 1.5rem 0;
  }

  .no-results-button {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    background: #2563eb;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .no-results-button:hover {
    background: #1d4ed8;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
  }

  /* Property Grid */
  .property-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .pagination-container {
    margin-top: 3rem;
  }

  @media (max-width: 640px) {
    .results-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }

    .property-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    
    // ✅ TRACKING: Track search event (only if there are search parameters)
    if (urlParams.toString() && window.StratosTracker) {
      const searchParams: Record<string, any> = {};
      urlParams.forEach((value, key) => {
        searchParams[key] = value;
      });

      const resultsCount = document.querySelector('[data-results-count]')?.textContent || '0';

      window.StratosTracker.trackEvent('search', {
        search_params: searchParams,
        results_count: parseInt(resultsCount.match(/\d+/)?.[0] || '0'),
      });
    }
  });
</script>