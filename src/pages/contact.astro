---
// ========================================
// CONTACT PAGE
// Clean, minimal contact form with FAQ
// Uses modular form-page components
// Dynamic contact info from Stratos CRM
// ========================================

import Layout from '../layouts/Layout.astro'
import { fetchBrandSettings, getContactInfo, getSocialLinks } from '../lib/brand'
import type { BrandSettings } from '../types/brand'

// Form Page Components
import FormPageLayout from '../components/form-page/layout/FormPageLayout.astro'
import FormHero from '../components/form-page/hero/FormHero.astro'
import ContactInfoGrid from '../components/form-page/contact-info/ContactInfoGrid.astro'
import FaqSection from '../components/form-page/faq/FaqSection.astro'

// Page content utilities
import { getPageContent } from '../lib/pages'

// Configuration
import { contactPageConfig, contactSubjectOptions } from '../components/form-page/config'

// Fetch brand settings from Stratos CRM
let brand: BrandSettings
try {
  brand = await fetchBrandSettings()
} catch (error) {
  console.error('[Contact] Error fetching brand settings:', error)
  brand = await fetchBrandSettings()
}

// Extract contact info and social links
const contactInfo = getContactInfo(brand)
const socialLinks = getSocialLinks(brand)

// Fetch contact page content from Stratos CRM
const pageContent = await getPageContent('contact')

const pageTitle = 'Contact Us'
const pageDescription = `Get in touch with ${brand.business_name || 'our team'}. We're here to help with all your property needs.`
---

<Layout title={pageTitle} description={pageDescription}>
  <FormPageLayout>
    <!-- Page Hero (block_key: contact_details) -->
    <FormHero
      title={contactPageConfig.hero.title}
      subtitle={contactPageConfig.hero.subtitle}
      blockKey={contactPageConfig.hero.blockKey}
      pageContent={pageContent}
    />

    <!-- Contact Info Cards -->
    <ContactInfoGrid
      contactInfo={contactInfo}
      socialLinks={socialLinks}
    />

    <!-- Form Section -->
    <section class="contact-form-section">
      <div class="contact-form-card">
        <form id="contact-form" class="contact-form">
          <!-- Honeypot field for bot protection -->
          <input type="text" name="website" style="display:none" tabindex="-1" autocomplete="off" />

          <!-- Two-column row: Name & Email -->
          <div class="contact-form__row">
            <div class="contact-form__group">
              <label for="name" class="contact-form__label">Full Name</label>
              <input
                type="text"
                id="name"
                name="name"
                required
                placeholder="John Smith"
                class="contact-form__input"
              />
            </div>

            <div class="contact-form__group">
              <label for="email" class="contact-form__label">Email Address</label>
              <input
                type="email"
                id="email"
                name="email"
                required
                placeholder="john@example.com"
                class="contact-form__input"
              />
            </div>
          </div>

          <!-- Single column: Phone -->
          <div class="contact-form__group">
            <label for="phone" class="contact-form__label">
              Phone Number
              <span class="contact-form__optional">(optional)</span>
            </label>
            <input
              type="tel"
              id="phone"
              name="phone"
              placeholder="07XXX XXXXXX"
              class="contact-form__input"
            />
          </div>

          <!-- Single column: Subject -->
          <div class="contact-form__group">
            <label for="subject" class="contact-form__label">What can we help with?</label>
            <select
              id="subject"
              name="subject"
              required
              class="contact-form__input contact-form__select"
            >
              {contactSubjectOptions.map(option => (
                <option value={option.value}>{option.label}</option>
              ))}
            </select>
          </div>

          <!-- Single column: Message -->
          <div class="contact-form__group">
            <label for="message" class="contact-form__label">Your Message</label>
            <textarea
              id="message"
              name="message"
              required
              placeholder="Tell us how we can help..."
              rows="5"
              class="contact-form__textarea"
            ></textarea>
          </div>

          <!-- Marketing opt-in -->
          <div class="contact-form__checkbox">
            <input
              type="checkbox"
              id="marketing_opt_in"
              name="marketing_opt_in"
              class="contact-form__checkbox-input"
            />
            <label for="marketing_opt_in" class="contact-form__checkbox-label">
              Keep me updated with property news and market insights
            </label>
          </div>

          <!-- Submit button - left aligned -->
          <div class="contact-form__actions">
            <button type="submit" class="contact-form__submit">
              Send Message
            </button>
          </div>

          <p class="contact-form__privacy">
            By submitting this form, you agree to our <a href="/privacy-policy">privacy policy</a>.
          </p>
        </form>

        <!-- Success Message -->
        <div id="success-message" class="contact-message contact-message--success">
          <svg class="contact-message__icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          <div class="contact-message__content">
            <h3 class="contact-message__title">Message Sent</h3>
            <p class="contact-message__text">Thank you for getting in touch. We'll respond within 24 hours.</p>
          </div>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="contact-message contact-message--error">
          <svg class="contact-message__icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" x2="12" y1="8" y2="12"></line>
            <line x1="12" x2="12.01" y1="16" y2="16"></line>
          </svg>
          <div class="contact-message__content">
            <h3 class="contact-message__title">Something went wrong</h3>
            <p class="contact-message__text" id="error-text">
              Please try again or contact us directly
              {contactInfo.phone && (
                <> on <a href={`tel:${contactInfo.phone.replace(/\s/g, '')}`}>{contactInfo.phone}</a></>
              )}
              {contactInfo.email && (
                <> or email <a href={`mailto:${contactInfo.email}`}>{contactInfo.email}</a></>
              )}.
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- FAQ Section -->
    <FaqSection
      title={contactPageConfig.faq.title}
      subtitle={contactPageConfig.faq.subtitle}
      items={contactPageConfig.faq.items}
    />
  </FormPageLayout>
</Layout>

<style lang="scss">
  @use '../styles/variables' as *;
  @use '../styles/mixins' as *;

  // Local design tokens
  $radius-sm: 10px;
  $radius-md: 12px;
  $radius-lg: 16px;
  $shadow-card: 0 4px 24px rgba(0, 0, 0, 0.06);
  $transition-fast: 150ms ease;
  $transition-base: 200ms ease;

  // Local colors for form inputs (can't use darken() with CSS vars)
  $bg-input: #F5F5F5;
  $bg-input-hover: #EFEFEF;

  // ========================================
  // FORM SECTION
  // ========================================

  .contact-form-section {
    padding: 0 24px;
    margin-bottom: 80px;

    @include mobile-only {
      padding: 0 20px;
      margin-bottom: 48px;
    }
  }

  .contact-form-card {
    max-width: 1020px;
    margin: 0 auto;
    background: $bg-white;
    border-radius: $radius-lg;
    box-shadow: $shadow-card;
    padding: 48px;

    @include mobile-only {
      padding: 32px 24px;
    }

    @media (max-width: 480px) {
      padding: 24px 20px;
      border-radius: $radius-md;
    }
  }

  .contact-form {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  // ========================================
  // FORM FIELDS
  // ========================================

  .contact-form__row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;

    @media (max-width: 640px) {
      grid-template-columns: 1fr;
      gap: 24px;
    }
  }

  .contact-form__group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .contact-form__label {
    font-size: 0.9375rem;
    font-weight: 500;
    color: $text-primary;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .contact-form__optional {
    font-size: 0.8125rem;
    font-weight: 400;
    color: $text-muted;
  }

  .contact-form__input,
  .contact-form__textarea,
  .contact-form__select {
    width: 100%;
    height: 65px;
    padding: 0 16px;
    font-family: $font-family-base;
    font-size: 1rem;
    color: $text-primary;
    background: $bg-input;
    border: none;
    border-radius: $radius-sm;
    transition: background $transition-fast, box-shadow $transition-fast;

    &::placeholder {
      color: $text-muted;
    }

    &:hover {
      background: $bg-input-hover;
    }

    &:focus {
      outline: none;
      background: $bg-white;
      box-shadow: 0 0 0 2px $accent-coral;
    }
  }

  .contact-form__select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236B7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    padding-right: 48px;
  }

  .contact-form__textarea {
    height: auto;
    min-height: 140px;
    padding: 16px;
    resize: vertical;
    line-height: 1.6;
  }

  @include mobile-only {
    .contact-form__input,
    .contact-form__select {
      height: 50px;
    }
  }

  // ========================================
  // CHECKBOX
  // ========================================

  .contact-form__checkbox {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding-top: 8px;
  }

  .contact-form__checkbox-input {
    width: 20px;
    height: 20px;
    margin-top: 2px;
    flex-shrink: 0;
    cursor: pointer;
    accent-color: $accent-coral;
  }

  .contact-form__checkbox-label {
    font-size: 0.9375rem;
    color: $text-secondary;
    line-height: 1.5;
    cursor: pointer;
  }

  // ========================================
  // SUBMIT BUTTON
  // ========================================

  .contact-form__actions {
    padding-top: 8px;
  }

  .contact-form__submit {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 52px;
    padding: 0 32px;
    background: $accent-coral;
    color: $bg-white;
    font-family: $font-family-base;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    border-radius: $radius-sm;
    cursor: pointer;
    transition: background $transition-fast, transform $transition-fast, box-shadow $transition-fast;

    &:hover {
      background: $accent-coral-dark;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba($accent-coral, 0.3);
    }

    &:active {
      transform: translateY(0);
    }

    &:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
  }

  // ========================================
  // PRIVACY NOTICE
  // ========================================

  .contact-form__privacy {
    font-size: 0.8125rem;
    color: $text-muted;
    margin: 0;
    line-height: 1.5;

    a {
      color: $text-secondary;
      text-decoration: underline;
      transition: color $transition-fast;

      &:hover {
        color: $accent-coral;
      }
    }
  }

  // ========================================
  // MESSAGES (SUCCESS/ERROR)
  // ========================================

  .contact-message {
    display: none;
    align-items: flex-start;
    gap: 16px;
    padding: 24px;
    border-radius: $radius-md;

    &.is-visible {
      display: flex;
    }
  }

  .contact-message--success {
    background: #ECFDF5;
    color: #065F46;
  }

  .contact-message--error {
    background: #FEF2F2;
    color: #991B1B;
  }

  .contact-message__icon {
    flex-shrink: 0;
    margin-top: 2px;
  }

  .contact-message__content {
    flex: 1;
  }

  .contact-message__title {
    font-size: 1rem;
    font-weight: 600;
    margin: 0 0 4px 0;
  }

  .contact-message__text {
    font-size: 0.9375rem;
    margin: 0;
    line-height: 1.5;
    opacity: 0.9;

    a {
      color: inherit;
      font-weight: 600;
      text-decoration: underline;
    }
  }
</style>

<script>
  import { getSessionId } from '../lib/session';

  // ========================================
  // FORM HANDLING
  // ========================================

  const form = document.querySelector('#contact-form') as HTMLFormElement;
  const successMessage = document.querySelector('#success-message') as HTMLElement;
  const errorMessage = document.querySelector('#error-message') as HTMLElement;
  const errorText = document.querySelector('#error-text') as HTMLElement;
  const submitButton = form?.querySelector('button[type="submit"]') as HTMLButtonElement;

  // Track when user starts filling the form
  let formStarted = false;

  const trackFormStart = async () => {
    if (formStarted) return;
    formStarted = true;

    const sessionId = getSessionId();

    try {
      await fetch(
        `${import.meta.env.PUBLIC_SUPABASE_URL}/functions/v1/track-event`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': import.meta.env.PUBLIC_WEBSITE_API_KEY,
          },
          body: JSON.stringify({
            session_id: sessionId,
            event_type: 'enquiry_started',
            event_data: {
              enquiry_type: 'general_enquiry',
              form_type: 'contact_form'
            }
          }),
        }
      );
    } catch (error) {
      console.error('Failed to track form start:', error);
    }
  };

  // Add event listeners to track form interaction
  form?.querySelectorAll('input, textarea, select').forEach(element => {
    element.addEventListener('focus', trackFormStart, { once: true });
  });

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!submitButton) return;

    const formData = new FormData(e.target as HTMLFormElement);
    const sessionId = getSessionId();

    // Show loading state
    submitButton.disabled = true;
    const originalContent = submitButton.innerHTML;
    submitButton.innerHTML = 'Sending...';

    try {
      // Get the selected subject and build message
      const subject = formData.get('subject') as string;
      const message = formData.get('message') as string;

      // Prepend subject to message if subject selector is shown
      const fullMessage = subject
        ? `Subject: ${subject}\n\n${message}`
        : message;

      // Map subject to appropriate enquiry_type
      const enquiryTypeMap: Record<string, string> = {
        'general_enquiry': 'general_enquiry',
        'property_enquiry': 'general_enquiry',
        'viewing_request': 'viewing_request',
        'valuation_request': 'valuation_request',
        'selling_enquiry': 'general_enquiry',
        'buying_enquiry': 'general_enquiry',
        'lettings_enquiry': 'general_enquiry',
        'other': 'general_enquiry'
      };

      const enquiryType = subject ? (enquiryTypeMap[subject] || 'general_enquiry') : 'general_enquiry';

      const response = await fetch(
        `${import.meta.env.PUBLIC_SUPABASE_URL}/functions/v1/submit-enquiry`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': import.meta.env.PUBLIC_WEBSITE_API_KEY,
          },
          body: JSON.stringify({
            session_id: sessionId,
            contact_name: formData.get('name'),
            contact_email: formData.get('email'),
            contact_phone: formData.get('phone') || null,
            message: fullMessage,
            property_id: null,
            enquiry_type: enquiryType,
            marketing_opt_in: formData.get('marketing_opt_in') === 'on',
            honeypot: formData.get('website'),
          }),
        }
      );

      const result = await response.json();

      if (result.success) {
        // Hide form and show success message
        form.style.display = 'none';
        successMessage.classList.add('is-visible');

        // Track successful submission
        try {
          await fetch(
            `${import.meta.env.PUBLIC_SUPABASE_URL}/functions/v1/track-event`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-api-key': import.meta.env.PUBLIC_WEBSITE_API_KEY,
              },
              body: JSON.stringify({
                session_id: sessionId,
                event_type: 'enquiry_submitted',
                event_data: {
                  enquiry_type: enquiryType,
                  enquiry_id: result.data.enquiry_id,
                  lead_score: result.data.lead_score,
                  priority: result.data.priority,
                  subject: subject || 'no_subject',
                  form_type: 'contact_form'
                }
              }),
            }
          );
        } catch (trackError) {
          console.error('Failed to track submission:', trackError);
        }
      } else {
        throw new Error(result.message || 'Submission failed');
      }
    } catch (error) {
      console.error('Error submitting form:', error);
      errorMessage.classList.add('is-visible');

      if (error instanceof Error && error.message) {
        errorText.textContent = error.message;
      }

      // Hide error message after 5 seconds
      setTimeout(() => {
        errorMessage.classList.remove('is-visible');
        errorText.textContent = 'Please try again or contact us directly.';
      }, 5000);
    } finally {
      submitButton.disabled = false;
      submitButton.innerHTML = originalContent;
    }
  });
</script>
