---
import Layout from '../layouts/Layout.astro'
import Hero from '../components/home/hero.astro'
import FeaturedProperties from '../components/home/FeaturedProperties.astro'
import WhyChooseUs from '../components/home/WhyChooseUs.astro'
// import RecentReviews from '../components/home/RecentReviews.astro'
import CallToAction from '../components/home/CallToAction.astro'

const API_ENDPOINT = import.meta.env.PUBLIC_STRATOS_API_ENDPOINT
const API_KEY = import.meta.env.PUBLIC_STRATOS_API_KEY
const AGENCY_ID = import.meta.env.PUBLIC_AGENCY_ID

// Fetch featured properties (SSR)
let featuredProperties = []

try {
  const response = await fetch(`${API_ENDPOINT}/get-featured-properties`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'apikey': API_KEY,  // âœ… Use 'apikey'
    },
    body: JSON.stringify({
      agency_id: AGENCY_ID,
      limit: 6,
    }),
  })

  if (response.ok) {
    const data = await response.json()
    featuredProperties = data.properties || []
  }
} catch (error) {
  console.error('Failed to fetch featured properties:', error)
}

// Page metadata
const title = 'Find Your Dream Home | Premier Estate Agents'
const description = 'Browse properties for sale and to rent. Expert estate agents helping you find your perfect home in Manchester and surrounding areas.'
---

<Layout title={title} description={description}>
  <!-- Hero Section with Search -->
  <Hero />

  <!-- Featured Properties -->
  <FeaturedProperties properties={featuredProperties} />

  <!-- Why Choose Us -->
  <WhyChooseUs />

  <!-- Recent Reviews -->
  <!-- <RecentReviews /> -->

  <!-- Call to Action -->
  <CallToAction />
</Layout>

<script>
  // Track homepage view
  if (window.StratosTracker) {
    window.StratosTracker.track('page_view', {
      page: '/',
      title: 'Home'
    })
  }
</script>