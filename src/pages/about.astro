---
// ========================================
// ABOUT PAGE - DYNAMIC CONTENT
// Fetches content from Stratos CRM Page Content feature
// Falls back to defaults if content unavailable
// ========================================

import Layout from '../layouts/Layout.astro'
import { fetchBrandSettings } from '../lib/brand'

// Static Page Components
import StaticPageLayout from '../components/static-page/layout/StaticPageLayout.astro'
import StaticHero from '../components/static-page/hero/StaticHero.astro'
import ShowcaseGrid from '../components/static-page/showcase/ShowcaseGrid.astro'
import ShowcaseCard from '../components/static-page/showcase/ShowcaseCard.astro'
import PartnersCarousel from '../components/static-page/partners/PartnersCarousel.astro'
import ContentSection from '../components/static-page/content/ContentSection.astro'
import ContentRow from '../components/static-page/content/ContentRow.astro'
import TestimonialSection from '../components/static-page/testimonial/TestimonialSection.astro'
import CtaSection from '../components/static-page/cta/CtaSection.astro'

// Page content utilities
import {
  getPageContent,
  getAllSections,
  getSectionContent,
  type ContentBlock,
} from '../lib/pages'

// Page configuration
import { aboutPageConfig } from '../components/static-page/config'

// Fetch brand settings
const brand = await fetchBrandSettings(true)

// Fetch page content from Stratos CRM
const pageContent = await getPageContent('about')

// Extract hero data with fallbacks
const heroTitle = pageContent?.page_title || 'About Us'
const heroSubtitle = 'Your trusted partner in property'
const heroImage = pageContent?.hero_image_url ? {
  url: pageContent.hero_image_url,
  alt: pageContent.hero_image_alt || heroTitle
} : null

// Get all content sections from the CRM (for any additional dynamic sections)
const allSections = getAllSections(pageContent)
const knownBlockKeys = ['our_story', 'our_values', 'meet_the_team']
const additionalSections = allSections.filter(s => !knownBlockKeys.includes(s.block_key))

// Check if we have content
const hasHeroImage = !!heroImage?.url

// Page meta
const pageTitle = 'About Us'
const pageDescription = heroSubtitle || 'Learn more about our team and our commitment to helping you find your perfect property.'

// Debug: Log content status (remove in production)
console.log('[About Page] Content fetched:', pageContent ? 'Yes' : 'No (using defaults)')
console.log('[About Page] Sections count:', allSections.length)
---

<Layout title={pageTitle} description={pageDescription}>
  <StaticPageLayout>
    <!-- Hero Section - Dynamic from Stratos -->
    <StaticHero
      title={heroTitle}
      tagline={heroSubtitle || brand.tagline || 'Your trusted partner in property, delivering exceptional service since day one.'}
      ctaLabel="View Properties"
      ctaUrl="/properties"
      heroImage={hasHeroImage ? heroImage?.url : undefined}
      heroImageAlt={hasHeroImage ? heroImage?.alt : undefined}
    />

    <!-- Showcase Section -->
    <ShowcaseGrid>
      <ShowcaseCard
        variant="primary"
        title="Complete Property Services"
        description="From finding your dream home to selling your property, we handle every step of your journey with care and expertise."
        features={[
          { text: 'Sales & Lettings' },
          { text: 'Property Management' },
          { text: 'Free Valuations' },
        ]}
        image="https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=600&h=400&fit=crop"
        imageAlt="Property services"
      >
        <Fragment slot="icon">
          <div class="showcase__card-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
          </div>
        </Fragment>
      </ShowcaseCard>

      <ShowcaseCard
        variant="secondary"
        subtitle="Local Expertise"
        description="Deep knowledge of the local market means we find opportunities others miss."
        image="https://images.unsplash.com/photo-1582407947304-fd86f028f716?w=400&h=500&fit=crop"
        imageAlt="Local expertise"
        tallImage
      />
    </ShowcaseGrid>

    <!-- Partners Section -->
    <PartnersCarousel
      label={aboutPageConfig.partners?.label}
      partners={aboutPageConfig.partners?.partners}
    />

    <!-- Content Sections from Stratos CRM -->
    <ContentSection>
      <!-- OUR STORY Section (block_key: our_story) -->
      <ContentRow
        label="Our Story"
        blockKey="our_story"
        pageContent={pageContent}
        title="Our Story"
        content="<p>What started as a small family business has grown into a thriving agency with a reputation for excellence.</p>"
      />

      <!-- OUR VALUES Section (block_key: our_values) -->
      <ContentRow
        label="Our Values"
        blockKey="our_values"
        pageContent={pageContent}
        title="Our Values"
        content="<ul><li><strong>Integrity:</strong> We always do what's right for our clients.</li><li><strong>Excellence:</strong> We strive for the highest standards.</li></ul>"
      />

      <!-- MEET THE TEAM Section (block_key: meet_the_team) -->
      <ContentRow
        label="The Team"
        blockKey="meet_the_team"
        pageContent={pageContent}
        title="Meet The Team"
        content="<p>Our experienced team brings together decades of local property knowledge.</p>"
        isCta
        actions={[
          { label: 'Get in Touch', url: '/contact', variant: 'primary', icon: true },
        ]}
      />

      <!-- Additional dynamic sections from CRM (beyond the known block keys) -->
      {additionalSections.map((block: ContentBlock) => (
        <ContentRow
          label={block.block_key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}
          title={block.section?.title || ''}
          content={block.section?.content || ''}
          image={block.section?.image?.url}
          imageAlt={block.section?.image?.alt || block.block_key}
        />
      ))}
    </ContentSection>

    <!-- Testimonial Section -->
    <TestimonialSection
      quote={aboutPageConfig.testimonial?.quote}
      author={aboutPageConfig.testimonial?.author}
      avatars={aboutPageConfig.testimonial?.avatars}
    />

    <!-- CTA Section -->
    <CtaSection
      title="Ready to find your perfect property?"
      description="Whether you're buying, selling, or renting, we're here to help every step of the way."
      actions={[
        { label: 'Get Started', url: '/contact', variant: 'primary', icon: true },
        { label: 'Free Valuation', url: '/valuation', variant: 'secondary' },
      ]}
    />
  </StaticPageLayout>
</Layout>

<style lang="scss">
  @use '../styles/variables' as *;
  @use '../styles/mixins' as *;

  .debug-info {
    padding: 20px 40px;
    background: #f0f0f0;
    border-top: 1px solid #ddd;

    details {
      max-width: 1200px;
      margin: 0 auto;
    }

    summary {
      cursor: pointer;
      font-weight: 600;
      color: #666;
    }

    pre {
      margin-top: 12px;
      padding: 16px;
      background: #fff;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 12px;
    }
  }
</style>
