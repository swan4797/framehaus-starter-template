---
// ========================================
// VALUATION PAGE
// Clean, minimal valuation request form with FAQ
// Design: White bg, 720-760px width, luxury whitespace
// Dynamic contact info from Stratos CRM
// ========================================

import Layout from '../layouts/Layout.astro'
import { fetchBrandSettings, getContactInfo } from '../lib/brand'
import type { BrandSettings } from '../types/brand'

// Fetch brand settings from Stratos CRM
let brand: BrandSettings
try {
  brand = await fetchBrandSettings()
} catch (error) {
  console.error('[Valuation] Error fetching brand settings:', error)
  brand = await fetchBrandSettings()
}

// Extract contact info
const contactInfo = getContactInfo(brand)

const pageTitle = 'Free Property Valuation'
const pageDescription = `Get a free, no-obligation property valuation from ${brand.business_name || 'expert local agents'}. Discover what your home is worth in today's market.`

// FAQ Data
const faqs = [
  {
    question: 'Is the valuation really free?',
    answer: 'Yes, absolutely. We provide free, no-obligation property valuations with no hidden costs. Whether you\'re thinking of selling now or in the future, there\'s no charge and no pressure to proceed.'
  },
  {
    question: 'How accurate are your valuations?',
    answer: 'Our valuations are based on real, up-to-date market data including recent sales, current listings, and local demand. We combine this with our agents\' local expertise to provide realistic figures you can trust.'
  },
  {
    question: 'Do I have to sell with you?',
    answer: 'Not at all. This is a completely free service with no obligation. Many people request valuations for financial planning, curiosity, or to understand their options. If and when you do decide to sell, we\'d love to help—but there\'s no pressure.'
  },
  {
    question: 'How long does it take?',
    answer: 'The form takes about 2 minutes to complete. You\'ll receive your detailed valuation report within 24 hours. If you\'d prefer a more in-depth assessment with a home visit, we can arrange that too.'
  },
  {
    question: 'What information do you need?',
    answer: 'Just basic details: your property address, type, number of bedrooms, and an optional estimate of what you think it\'s worth. This helps us prepare an accurate valuation tailored to your property.'
  },
  {
    question: 'Will you contact me afterwards?',
    answer: 'We\'ll send your valuation report and may follow up once to see if you have questions. We won\'t bombard you with calls or emails. You can opt out of marketing communications anytime.'
  }
]
---

<Layout title={pageTitle} description={pageDescription}>
  <div class="valuation-page">
    <!-- Page Header -->
    <section class="valuation-header">
      <div class="valuation-header__content">
        <h1 class="valuation-header__title">Free Property Valuation</h1>
        <p class="valuation-header__subtitle">
          Discover what your property is worth with a free, no-obligation market valuation from our local experts.
        </p>
      </div>
    </section>

    <!-- Form Section -->
    <section class="valuation-form-section">
      <div class="valuation-form-card">
        <form id="valuation-form" class="valuation-form">
          <!-- Honeypot field for bot protection -->
          <input type="text" name="website" style="display:none" tabindex="-1" autocomplete="off" />

          <!-- Section: Your Details -->
          <div class="valuation-form__section">
            <h3 class="valuation-form__section-title">Your Details</h3>

            <div class="valuation-form__group">
              <label for="name" class="valuation-form__label">Full Name</label>
              <input
                type="text"
                id="name"
                name="name"
                required
                placeholder="John Smith"
                class="valuation-form__input"
              />
            </div>

            <!-- Two-column row: Email & Phone -->
            <div class="valuation-form__row">
              <div class="valuation-form__group">
                <label for="email" class="valuation-form__label">Email Address</label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  required
                  placeholder="john@example.com"
                  class="valuation-form__input"
                />
              </div>

              <div class="valuation-form__group">
                <label for="phone" class="valuation-form__label">Phone Number</label>
                <input
                  type="tel"
                  id="phone"
                  name="phone"
                  required
                  placeholder="07XXX XXXXXX"
                  class="valuation-form__input"
                />
              </div>
            </div>
          </div>

          <!-- Section: Property Details -->
          <div class="valuation-form__section">
            <h3 class="valuation-form__section-title">Property Details</h3>

            <div class="valuation-form__group">
              <label for="address" class="valuation-form__label">Property Address</label>
              <input
                type="text"
                id="address"
                name="address"
                required
                placeholder="123 High Street, London"
                class="valuation-form__input"
              />
            </div>

            <div class="valuation-form__group">
              <label for="postcode" class="valuation-form__label">Postcode</label>
              <input
                type="text"
                id="postcode"
                name="postcode"
                required
                placeholder="SW1A 1AA"
                class="valuation-form__input"
                maxlength="8"
              />
            </div>

            <!-- Two-column row: Property Type & Bedrooms -->
            <div class="valuation-form__row">
              <div class="valuation-form__group">
                <label for="property_type" class="valuation-form__label">Property Type</label>
                <select
                  id="property_type"
                  name="property_type"
                  required
                  class="valuation-form__input valuation-form__select"
                >
                  <option value="">Select type...</option>
                  <option value="house">House</option>
                  <option value="flat">Flat/Apartment</option>
                  <option value="bungalow">Bungalow</option>
                  <option value="terraced">Terraced House</option>
                  <option value="semi-detached">Semi-Detached</option>
                  <option value="detached">Detached House</option>
                  <option value="other">Other</option>
                </select>
              </div>

              <div class="valuation-form__group">
                <label for="bedrooms" class="valuation-form__label">Bedrooms</label>
                <select
                  id="bedrooms"
                  name="bedrooms"
                  required
                  class="valuation-form__input valuation-form__select"
                >
                  <option value="">Select...</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6+">6+</option>
                </select>
              </div>
            </div>

            <div class="valuation-form__group">
              <label for="estimated_value" class="valuation-form__label">
                Estimated Value
                <span class="valuation-form__optional">(optional)</span>
              </label>
              <div class="valuation-form__input-prefix">
                <span class="valuation-form__prefix">£</span>
                <input
                  type="text"
                  id="estimated_value"
                  name="estimated_value"
                  placeholder="e.g., 450,000"
                  class="valuation-form__input valuation-form__input--prefixed"
                />
              </div>
            </div>

            <div class="valuation-form__group">
              <label for="reason" class="valuation-form__label">Reason for Valuation</label>
              <select
                id="reason"
                name="reason"
                required
                class="valuation-form__input valuation-form__select"
              >
                <option value="">Select reason...</option>
                <option value="selling">Planning to sell</option>
                <option value="curious">Just curious</option>
                <option value="remortgage">Remortgage</option>
                <option value="inheritance">Inheritance/Tax</option>
                <option value="other">Other</option>
              </select>
            </div>

            <div class="valuation-form__group">
              <label for="message" class="valuation-form__label">
                Additional Information
                <span class="valuation-form__optional">(optional)</span>
              </label>
              <textarea
                id="message"
                name="message"
                placeholder="Any special features, recent improvements, or questions?"
                rows="4"
                class="valuation-form__textarea"
              ></textarea>
            </div>
          </div>

          <!-- Marketing opt-in -->
          <div class="valuation-form__checkbox">
            <input
              type="checkbox"
              id="marketing_opt_in"
              name="marketing_opt_in"
              class="valuation-form__checkbox-input"
            />
            <label for="marketing_opt_in" class="valuation-form__checkbox-label">
              Send me property market updates and selling tips
            </label>
          </div>

          <!-- Submit button - left aligned -->
          <div class="valuation-form__actions">
            <button type="submit" class="valuation-form__submit">
              Request Free Valuation
            </button>
          </div>

          <p class="valuation-form__privacy">
            By submitting this form, you agree to our <a href="/privacy-policy">privacy policy</a>.
          </p>
        </form>

        <!-- Success Message -->
        <div id="success-message" class="valuation-message valuation-message--success">
          <svg class="valuation-message__icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          <div class="valuation-message__content">
            <h3 class="valuation-message__title">Valuation Request Received</h3>
            <p class="valuation-message__text">Thank you! We'll prepare your detailed market valuation and be in touch within 24 hours.</p>
          </div>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="valuation-message valuation-message--error">
          <svg class="valuation-message__icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" x2="12" y1="8" y2="12"></line>
            <line x1="12" x2="12.01" y1="16" y2="16"></line>
          </svg>
          <div class="valuation-message__content">
            <h3 class="valuation-message__title">Something went wrong</h3>
            <p class="valuation-message__text" id="error-text">
              Please try again or contact us directly
              {contactInfo.phone && (
                <> on <a href={`tel:${contactInfo.phone.replace(/\s/g, '')}`}>{contactInfo.phone}</a></>
              )}
              {contactInfo.email && (
                <> or email <a href={`mailto:${contactInfo.email}`}>{contactInfo.email}</a></>
              )}.
            </p>
          </div>
        </div>

        <!-- Contact Alternative -->
        {(contactInfo.phone || contactInfo.email) && (
          <div class="valuation-contact-alt">
            <p class="valuation-contact-alt__text">
              Prefer to speak directly?
              {contactInfo.phone && (
                <>Call us on <a href={`tel:${contactInfo.phone.replace(/\s/g, '')}`}>{contactInfo.phone}</a></>
              )}
              {contactInfo.phone && contactInfo.email && <> or </>}
              {contactInfo.email && (
                <>email <a href={`mailto:${contactInfo.email}`}>{contactInfo.email}</a></>
              )}
            </p>
          </div>
        )}
      </div>
    </section>

    <!-- FAQ Section -->
    <section class="faq-section">
      <div class="faq-section__header">
        <h2 class="faq-section__title">Frequently Asked Questions</h2>
        <p class="faq-section__subtitle">Everything you need to know about our valuation service</p>
      </div>

      <div class="faq-accordion">
        {faqs.map((faq, index) => (
          <div class="faq-item" data-faq-item>
            <button
              class="faq-item__trigger"
              type="button"
              aria-expanded="false"
              aria-controls={`faq-content-${index}`}
            >
              <span class="faq-item__question">{faq.question}</span>
              <svg class="faq-item__icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
            <div
              class="faq-item__content"
              id={`faq-content-${index}`}
              aria-hidden="true"
            >
              <p class="faq-item__answer">{faq.answer}</p>
            </div>
          </div>
        ))}
      </div>
    </section>
  </div>
</Layout>

<style lang="scss">
  // ========================================
  // DESIGN TOKENS
  // ========================================

  // Colors
  $accent-coral: #FF5A5F;
  $accent-coral-hover: #E74E52;
  $text-primary: #1A1A1A;
  $text-secondary: #6B7280;
  $text-muted: #9CA3AF;
  $bg-white: #FFFFFF;
  $bg-input: #F5F5F5;
  $bg-input-hover: #EFEFEF;
  $border-light: #E5E7EB;

  // Spacing
  $page-max-width: 760px;
  $section-spacing: 80px;
  $section-spacing-mobile: 48px;

  // Borders
  $radius-sm: 10px;
  $radius-md: 12px;
  $radius-lg: 16px;

  // Shadows
  $shadow-card: 0 4px 24px rgba(0, 0, 0, 0.06);
  $shadow-faq: 0 2px 12px rgba(0, 0, 0, 0.04);

  // Transitions
  $transition-fast: 150ms ease;
  $transition-base: 200ms ease;
  $transition-smooth: 300ms cubic-bezier(0.4, 0, 0.2, 1);

  // Typography
  $font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;

  // ========================================
  // PAGE LAYOUT
  // ========================================

  .valuation-page {
    background: $bg-white;
    font-family: $font-family;
    padding-bottom: $section-spacing;

    @media (max-width: 768px) {
      padding-bottom: $section-spacing-mobile;
    }
  }

  // ========================================
  // PAGE HEADER
  // ========================================

  .valuation-header {
    padding: 64px 24px 48px;
    text-align: center;

    @media (max-width: 768px) {
      padding: 40px 20px 32px;
    }
  }

  .valuation-header__content {
    max-width: $page-max-width;
    margin: 0 auto;
  }

  .valuation-header__title {
    font-size: 2.5rem;
    font-weight: 700;
    color: $text-primary;
    margin: 0 0 16px 0;
    line-height: 1.2;
    letter-spacing: -0.02em;

    @media (max-width: 768px) {
      font-size: 2rem;
    }
  }

  .valuation-header__subtitle {
    font-size: 1.125rem;
    color: $text-secondary;
    margin: 0;
    line-height: 1.6;
    max-width: 520px;
    margin-left: auto;
    margin-right: auto;

    @media (max-width: 768px) {
      font-size: 1rem;
    }
  }

  // ========================================
  // FORM SECTION
  // ========================================

  .valuation-form-section {
    padding: 0 24px;
    margin-bottom: $section-spacing;

    @media (max-width: 768px) {
      padding: 0 20px;
      margin-bottom: $section-spacing-mobile;
    }
  }

  .valuation-form-card {
    max-width: 1020px;
    margin: 0 auto;
    background: $bg-white;
    border-radius: $radius-lg;
    box-shadow: $shadow-card;
    padding: 48px;

    @media (max-width: 768px) {
      padding: 32px 24px;
    }

    @media (max-width: 480px) {
      padding: 24px 20px;
      border-radius: $radius-md;
    }
  }

  .valuation-form {
    display: flex;
    flex-direction: column;
    gap: 32px;
  }

  // ========================================
  // FORM SECTIONS
  // ========================================

  .valuation-form__section {
    display: flex;
    flex-direction: column;
    gap: 20px;
    padding-bottom: 32px;
    border-bottom: 1px solid $border-light;

    &:last-of-type {
      border-bottom: none;
      padding-bottom: 0;
    }
  }

  .valuation-form__section-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: $text-primary;
    margin: 0 0 4px 0;
  }

  // ========================================
  // FORM FIELDS
  // ========================================

  .valuation-form__row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;

    @media (max-width: 640px) {
      grid-template-columns: 1fr;
      gap: 20px;
    }
  }

  .valuation-form__group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .valuation-form__label {
    font-size: 0.9375rem;
    font-weight: 500;
    color: $text-primary;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .valuation-form__optional {
    font-size: 0.8125rem;
    font-weight: 400;
    color: $text-muted;
  }

  .valuation-form__input,
  .valuation-form__textarea,
  .valuation-form__select {
    width: 100%;
    height: 65px;
    padding: 0 16px;
    font-family: $font-family;
    font-size: 1rem;
    color: $text-primary;
    background: $bg-input;
    border: none;
    border-radius: $radius-sm;
    transition: background $transition-fast, box-shadow $transition-fast;

    &::placeholder {
      color: $text-muted;
    }

    &:hover {
      background: $bg-input-hover;
    }

    &:focus {
      outline: none;
      background: $bg-white;
      box-shadow: 0 0 0 2px $accent-coral;
    }
  }

  .valuation-form__select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236B7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    padding-right: 48px;
  }

  .valuation-form__textarea {
    height: auto;
    min-height: 120px;
    padding: 16px;
    resize: vertical;
    line-height: 1.6;
  }

  @media (max-width: 768px) {
    .valuation-form__input,
    .valuation-form__select {
      height: 50px;
    }
  }

  // Input with prefix (currency)
  .valuation-form__input-prefix {
    position: relative;
    display: flex;
    align-items: center;
  }

  .valuation-form__prefix {
    position: absolute;
    left: 16px;
    font-size: 1rem;
    font-weight: 500;
    color: $text-secondary;
    pointer-events: none;
    z-index: 1;
  }

  .valuation-form__input--prefixed {
    padding-left: 32px;
  }

  // ========================================
  // CHECKBOX
  // ========================================

  .valuation-form__checkbox {
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }

  .valuation-form__checkbox-input {
    width: 20px;
    height: 20px;
    margin-top: 2px;
    flex-shrink: 0;
    cursor: pointer;
    accent-color: $accent-coral;
  }

  .valuation-form__checkbox-label {
    font-size: 0.9375rem;
    color: $text-secondary;
    line-height: 1.5;
    cursor: pointer;
  }

  // ========================================
  // SUBMIT BUTTON
  // ========================================

  .valuation-form__actions {
    padding-top: 8px;
  }

  .valuation-form__submit {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 52px;
    padding: 0 32px;
    background: $accent-coral;
    color: $bg-white;
    font-family: $font-family;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    border-radius: $radius-sm;
    cursor: pointer;
    transition: background $transition-fast, transform $transition-fast, box-shadow $transition-fast;

    &:hover {
      background: $accent-coral-hover;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba($accent-coral, 0.3);
    }

    &:active {
      transform: translateY(0);
    }

    &:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
  }

  // ========================================
  // PRIVACY NOTICE
  // ========================================

  .valuation-form__privacy {
    font-size: 0.8125rem;
    color: $text-muted;
    margin: 0;
    line-height: 1.5;

    a {
      color: $text-secondary;
      text-decoration: underline;
      transition: color $transition-fast;

      &:hover {
        color: $accent-coral;
      }
    }
  }

  // ========================================
  // MESSAGES (SUCCESS/ERROR)
  // ========================================

  .valuation-message {
    display: none;
    align-items: flex-start;
    gap: 16px;
    padding: 24px;
    border-radius: $radius-md;

    &.is-visible {
      display: flex;
    }
  }

  .valuation-message--success {
    background: #ECFDF5;
    color: #065F46;
  }

  .valuation-message--error {
    background: #FEF2F2;
    color: #991B1B;
  }

  .valuation-message__icon {
    flex-shrink: 0;
    margin-top: 2px;
  }

  .valuation-message__content {
    flex: 1;
  }

  .valuation-message__title {
    font-size: 1rem;
    font-weight: 600;
    margin: 0 0 4px 0;
  }

  .valuation-message__text {
    font-size: 0.9375rem;
    margin: 0;
    line-height: 1.5;
    opacity: 0.9;

    a {
      color: inherit;
      font-weight: 600;
      text-decoration: underline;
    }
  }

  // ========================================
  // CONTACT ALTERNATIVE
  // ========================================

  .valuation-contact-alt {
    margin-top: 32px;
    padding: 20px 24px;
    background: $bg-input;
    border-radius: $radius-md;
    text-align: center;
  }

  .valuation-contact-alt__text {
    font-size: 0.9375rem;
    color: $text-secondary;
    margin: 0;
    line-height: 1.6;

    a {
      color: $accent-coral;
      font-weight: 600;
      text-decoration: none;
      transition: color $transition-fast;

      &:hover {
        color: $accent-coral-hover;
        text-decoration: underline;
      }
    }
  }

  // ========================================
  // FAQ SECTION
  // ========================================

  .faq-section {
    padding: 0 24px;
    max-width: $page-max-width;
    margin: 0 auto;

    @media (max-width: 768px) {
      padding: 0 20px;
    }
  }

  .faq-section__header {
    text-align: center;
    margin-bottom: 40px;

    @media (max-width: 768px) {
      margin-bottom: 32px;
    }
  }

  .faq-section__title {
    font-size: 1.75rem;
    font-weight: 700;
    color: $text-primary;
    margin: 0 0 12px 0;
    letter-spacing: -0.01em;

    @media (max-width: 768px) {
      font-size: 1.5rem;
    }
  }

  .faq-section__subtitle {
    font-size: 1rem;
    color: $text-secondary;
    margin: 0;
  }

  // ========================================
  // FAQ ACCORDION
  // ========================================

  .faq-accordion {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .faq-item {
    background: $bg-white;
    border-radius: $radius-md;
    box-shadow: $shadow-faq;
    overflow: hidden;
    transition: box-shadow $transition-base;

    &:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
    }

    &.is-open {
      .faq-item__icon {
        transform: rotate(180deg);
      }

      .faq-item__content {
        grid-template-rows: 1fr;
        opacity: 1;
      }
    }
  }

  .faq-item__trigger {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    padding: 48px 48px 48px 54px;
    background: transparent;
    border: none;
    cursor: pointer;
    text-align: left;

    @media (max-width: 768px) {
      padding: 16px 20px;
    }
  }

  .faq-item__question {
    font-family: $font-family;
    font-size: 22px;
    font-weight: 700;
    color: $text-primary;
    line-height: 1.364em;
  }

  .faq-item__icon {
    flex-shrink: 0;
    color: $text-muted;
    transition: transform $transition-smooth;
  }

  .faq-item__content {
    display: grid;
    grid-template-rows: 0fr;
    opacity: 0;
    transition: grid-template-rows $transition-smooth, opacity $transition-smooth;
  }

  .faq-item__answer {
    overflow: hidden;
    padding: 0;
    font-size: 20px;
    color: $text-secondary;
    line-height: 1.7;
    margin: 0;

    .faq-item.is-open & {
      padding: 0 48px 48px 54px;
    }

    @media (max-width: 768px) {
      .faq-item.is-open & {
        padding: 0 20px 16px 20px;
      }
    }
  }
</style>

<script>
  import { getSessionId } from '../lib/session';

  // ========================================
  // FORM HANDLING
  // ========================================

  const form = document.querySelector('#valuation-form') as HTMLFormElement;
  const successMessage = document.querySelector('#success-message') as HTMLElement;
  const errorMessage = document.querySelector('#error-message') as HTMLElement;
  const errorText = document.querySelector('#error-text') as HTMLElement;
  const submitButton = form?.querySelector('button[type="submit"]') as HTMLButtonElement;

  // Track when user starts filling the form
  let formStarted = false;

  const trackFormStart = async () => {
    if (formStarted) return;
    formStarted = true;

    const sessionId = getSessionId();

    try {
      await fetch(
        `${import.meta.env.PUBLIC_SUPABASE_URL}/functions/v1/track-event`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': import.meta.env.PUBLIC_WEBSITE_API_KEY,
          },
          body: JSON.stringify({
            session_id: sessionId,
            event_type: 'enquiry_started',
            event_data: {
              enquiry_type: 'valuation_request',
              form_type: 'valuation_request'
            }
          }),
        }
      );
    } catch (error) {
      console.error('Failed to track form start:', error);
    }
  };

  // Add event listeners to track form interaction
  form?.querySelectorAll('input, textarea, select').forEach(element => {
    element.addEventListener('focus', trackFormStart, { once: true });
  });

  // Format currency input
  const estimatedValueInput = form?.querySelector('#estimated_value') as HTMLInputElement;
  estimatedValueInput?.addEventListener('input', (e) => {
    const input = e.target as HTMLInputElement;
    const value = input.value.replace(/[^\d]/g, '');
    if (value) {
      input.value = Number(value).toLocaleString('en-GB');
    }
  });

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!submitButton) return;

    const formData = new FormData(e.target as HTMLFormElement);
    const sessionId = getSessionId();

    // Show loading state
    submitButton.disabled = true;
    const originalContent = submitButton.innerHTML;
    submitButton.innerHTML = 'Sending...';

    try {
      // Build comprehensive message from all property details
      const propertyDetails = [];

      propertyDetails.push(`Property Address: ${formData.get('address')}, ${formData.get('postcode')}`);
      propertyDetails.push(`Property Type: ${formData.get('property_type')}`);
      propertyDetails.push(`Bedrooms: ${formData.get('bedrooms')}`);

      const estimatedValue = formData.get('estimated_value') as string;
      if (estimatedValue) {
        propertyDetails.push(`Estimated Value: £${estimatedValue}`);
      }

      propertyDetails.push(`Reason for Valuation: ${formData.get('reason')}`);

      const additionalInfo = formData.get('message') as string;
      if (additionalInfo) {
        propertyDetails.push(`\nAdditional Information:\n${additionalInfo}`);
      }

      const message = propertyDetails.join('\n');

      const response = await fetch(
        `${import.meta.env.PUBLIC_SUPABASE_URL}/functions/v1/submit-enquiry`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': import.meta.env.PUBLIC_WEBSITE_API_KEY,
          },
          body: JSON.stringify({
            session_id: sessionId,
            contact_name: formData.get('name'),
            contact_email: formData.get('email'),
            contact_phone: formData.get('phone'),
            message: message,
            property_id: null,
            enquiry_type: 'valuation_request',
            marketing_opt_in: formData.get('marketing_opt_in') === 'on',
            honeypot: formData.get('website'),
          }),
        }
      );

      const result = await response.json();

      if (result.success) {
        // Hide form and show success message
        form.style.display = 'none';
        successMessage.classList.add('is-visible');

        // Track successful submission
        try {
          await fetch(
            `${import.meta.env.PUBLIC_SUPABASE_URL}/functions/v1/track-event`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-api-key': import.meta.env.PUBLIC_WEBSITE_API_KEY,
              },
              body: JSON.stringify({
                session_id: sessionId,
                event_type: 'enquiry_submitted',
                event_data: {
                  enquiry_type: 'valuation_request',
                  enquiry_id: result.data.enquiry_id,
                  lead_score: result.data.lead_score,
                  priority: result.data.priority,
                  property_type: formData.get('property_type'),
                  bedrooms: formData.get('bedrooms'),
                  reason: formData.get('reason')
                }
              }),
            }
          );
        } catch (trackError) {
          console.error('Failed to track submission:', trackError);
        }
      } else {
        throw new Error(result.message || 'Submission failed');
      }
    } catch (error) {
      console.error('Error submitting form:', error);
      errorMessage.classList.add('is-visible');

      if (error instanceof Error && error.message) {
        errorText.textContent = error.message;
      }

      // Hide error message after 5 seconds
      setTimeout(() => {
        errorMessage.classList.remove('is-visible');
        errorText.textContent = 'Please try again or contact us directly.';
      }, 5000);
    } finally {
      submitButton.disabled = false;
      submitButton.innerHTML = originalContent;
    }
  });

  // ========================================
  // FAQ ACCORDION
  // ========================================

  const faqItems = document.querySelectorAll('[data-faq-item]');

  faqItems.forEach(item => {
    const trigger = item.querySelector('.faq-item__trigger') as HTMLButtonElement;

    trigger?.addEventListener('click', () => {
      const isOpen = item.classList.contains('is-open');
      const content = item.querySelector('.faq-item__content');

      // Close all other items
      faqItems.forEach(otherItem => {
        if (otherItem !== item) {
          otherItem.classList.remove('is-open');
          const otherTrigger = otherItem.querySelector('.faq-item__trigger');
          const otherContent = otherItem.querySelector('.faq-item__content');
          otherTrigger?.setAttribute('aria-expanded', 'false');
          otherContent?.setAttribute('aria-hidden', 'true');
        }
      });

      // Toggle current item
      if (isOpen) {
        item.classList.remove('is-open');
        trigger.setAttribute('aria-expanded', 'false');
        content?.setAttribute('aria-hidden', 'true');
      } else {
        item.classList.add('is-open');
        trigger.setAttribute('aria-expanded', 'true');
        content?.setAttribute('aria-hidden', 'false');
      }
    });
  });
</script>
