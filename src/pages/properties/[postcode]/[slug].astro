---
// File: src/pages/properties/[postcode]/[slug].astro
// UPDATED WITH TRACKING INTEGRATION

export const prerender = false

import PropertyLayout from '../../../layouts/PropertyLayout.astro'
import ImageGallery from '../../../components/propertydetails/ImageGallery.astro'
import EnquiryForm from '../../../components/forms/EnquiryForm.astro'
import { getPropertyDetails } from '../../../lib/api'
import {
  extractPropertyIdFromUrl,
  getDisplayPrice,
  formatPropertyType,
  formatDate,
  formatArea,
  getStatusBadgeText,
  getStatusBadgeClass,
  pluralize,
} from '../../../lib/utils'
import {PropertyMapSection } from '../../../components/map/PropertyMapIframe.tsx'
import ViewingRequestForm from '../../../components/forms/ViewingRequestForm.astro'

const propertyId = extractPropertyIdFromUrl(Astro.url.pathname)

if (!propertyId) {
  return Astro.redirect('/search')
}

const property = await getPropertyDetails(propertyId)

if (!property) {
  return Astro.redirect('/search')
}

const displayPrice = getDisplayPrice(property)
const propertyType = formatPropertyType(property.property_type)
const listedDate = property.listed_date ? formatDate(property.listed_date) : null
const statusText = getStatusBadgeText(property.listing_status)
const statusClass = getStatusBadgeClass(property.listing_status)

const structuredData = {
  '@context': 'https://schema.org',
  '@type': property.listing_type === 'sale' ? 'RealEstateListing' : 'Apartment',
  name: property.display_address,
  description: property.description || property.summary,
  address: {
    '@type': 'PostalAddress',
    streetAddress: property.address_line_1,
    addressLocality: property.city,
    addressRegion: property.county,
    postalCode: property.postcode,
    addressCountry: property.country_code,
  },
}

const hasLocation = property.latitude && property.longitude

---

<PropertyLayout 
  title={`${property.display_address} - ${propertyType}`}
  propertyId={property.id}
  description={property.summary || `${propertyType} in ${property.city || property.postcode}`}
>
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />

  <div class="bg-gray-50 min-h-screen py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Breadcrumbs -->
      <nav class="mb-6">
        <ol class="flex items-center space-x-2 text-sm">
          <li><a href="/" class="text-gray-500 hover:text-gray-700">Home</a></li>
          <li class="text-gray-400">/</li>
          <li>
            <a 
              href={`/search?listing_type=${property.listing_type}`}
              class="text-gray-500 hover:text-gray-700"
            >
              {property.listing_type === 'sale' ? 'For Sale' : 'To Rent'}
            </a>
          </li>
          <li class="text-gray-400">/</li>
          <li class="text-gray-900 font-medium">{property.display_address}</li>
        </ol>
      </nav>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2 space-y-6">
          <!-- ✅ Image Gallery with tracking -->
          <ImageGallery 
            images={property.property_media || []} 
            propertyAddress={property.display_address}
            propertyId={property.id}
          />

          <!-- Property Header -->
          <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">
                  {property.display_address}
                </h1>
                <p class="text-gray-600">
                  {property.city && `${property.city}, `}{property.postcode}
                </p>
              </div>
              {property.listing_status !== 'available' && (
                <span class:list={['px-4 py-2 rounded-full text-sm font-semibold', statusClass]}>
                  {statusText}
                </span>
              )}
            </div>

            <div class="flex flex-wrap items-center gap-6 py-4 border-t border-b border-gray-200">
              <div>
                <p class="text-3xl font-bold text-blue-600">{displayPrice}</p>
                <p class="text-sm text-gray-600">
                  {property.listing_type === 'sale' ? 'For Sale' : 'To Rent'}
                </p>
              </div>
              
              <div class="flex gap-6 text-gray-700">
                <div class="flex items-center gap-2">
                  <svg class="w-6 h-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                  </svg>
                  <span class="font-semibold">{property.bedrooms}</span>
                  <span class="text-sm">{pluralize(property.bedrooms, 'bed')}</span>
                </div>

                {property.bathrooms > 0 && (
                  <div class="flex items-center gap-2">
                    <svg class="w-6 h-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path>
                    </svg>
                    <span class="font-semibold">{property.bathrooms}</span>
                    <span class="text-sm">{pluralize(property.bathrooms, 'bath')}</span>
                  </div>
                )}
              </div>
            </div>

            <div class="mt-4 flex flex-wrap gap-4 text-sm text-gray-600">
              <span>{propertyType}</span>
              {property.tenure && <span>• {property.tenure}</span>}
              {listedDate && <span>• Listed {listedDate}</span>}
            </div>
          </div>

          <!-- Description -->
          {property.description && (
            <div class="bg-white rounded-lg shadow-md p-6">
              <h2 class="text-2xl font-bold text-gray-900 mb-4">Description</h2>
              <div class="prose max-w-none text-gray-700 whitespace-pre-line">
                {property.description}
              </div>
            </div>
          )}

          <!-- Key Features -->
          {property.key_features && property.key_features.length > 0 && (
            <div class="bg-white rounded-lg shadow-md p-6">
              <h2 class="text-2xl font-bold text-gray-900 mb-4">Key Features</h2>
              <ul class="grid grid-cols-1 md:grid-cols-2 gap-3">
                {property.key_features.map(feature => (
                  <li class="flex items-start">
                    <svg class="w-5 h-5 text-green-500 mr-2 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span class="text-gray-700">{feature}</span>
                  </li>
                ))}
              </ul>
            </div>
          )}


      {/* MAP SECTION - ADD THIS */}
      {hasLocation && (
        <PropertyMapSection
          latitude={property.latitude}
          longitude={property.longitude}
          address={property.display_address}
          postcode={property.postcode}
          displayAddress={property.display_address}
          provider="openstreetmap"
          client:load
        />
      )}
        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1">
          <div class="sticky top-24 space-y-6">
            <!-- ✅ Enquiry Form with session tracking -->
         
              <ViewingRequestForm property={property} />
         
            <!-- ✅ Contact Actions with tracking -->
            <div class="bg-white rounded-lg shadow-md p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Contact Us</h3>
              <div class="space-y-3">
                <a
                  href="tel:02012345678"
                  onclick="window.StratosTracker?.trackPhoneClick('02012345678')"
                  class="flex items-center justify-center gap-2 w-full bg-blue-600 text-white px-4 py-3 rounded-md hover:bg-blue-700 transition-colors font-medium"
                >
                  <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                  </svg>
                  Call Us
                </a>

                <a
                  href="mailto:info@agency.com"
                  onclick="window.StratosTracker?.trackEmailClick('info@agency.com')"
                  class="flex items-center justify-center gap-2 w-full bg-white border-2 border-gray-300 text-gray-700 px-4 py-3 rounded-md hover:bg-gray-50 transition-colors font-medium"
                >
                  <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                  </svg>
                  Email Us
                </a>
              </div>
            </div>

            <!-- ✅ Share with tracking -->
            <div class="bg-white rounded-lg shadow-md p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Share</h3>
              <button
                class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors"
                onclick={`
                  if (navigator.share) {
                    navigator.share({title: document.title, url: window.location.href})
                      .then(() => window.StratosTracker?.trackShare('${property.id}', 'native'))
                  }
                `}
              >
                Share Property
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ TRACKING: Property view and duration -->
  <!-- <script define:vars={{ propertyId: property.id }}>
    if (window.StratosTracker) {
      window.StratosTracker.trackEvent('property_view', {
        property_id: propertyId
      });
    }
  </script> -->

</PropertyLayout>