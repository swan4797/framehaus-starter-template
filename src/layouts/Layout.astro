---
// ========================================
// BASE LAYOUT
// Main layout with navigation, SEO, and footer
// ========================================

import { siteConfig } from '../lib/config'
import Header from '../components/Header.astro'
import Footer from '../components/Footer.astro'
import CookieConsent from '../components/CookieConsent.astro'
import BrandProvider from '../components/BrandProvider.astro'

interface Props {
  title?: string
  description?: string
  ogImage?: string
  canonicalUrl?: string
  noIndex?: boolean
}

const {
  title = siteConfig.name,
  description = siteConfig.description,
  ogImage = '/images/og-default.jpg',
  canonicalUrl = Astro.url.href,
  noIndex = false,
} = Astro.props

const fullTitle = title === siteConfig.name ? title : `${title} | ${siteConfig.name}`
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />

    <!-- SEO Meta Tags -->
    <title>{fullTitle}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalUrl} />
    
    {noIndex && <meta name="robots" content="noindex, nofollow" />}

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalUrl} />
    <meta property="twitter:title" content={fullTitle} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={ogImage} />

    <!-- Brand Provider - Dynamic theming from Stratos CRM -->
    <BrandProvider />

    <!-- Fallback Inter font (brand fonts loaded by BrandProvider) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>

  <body class="body_wrapper">
    <!-- Header Navigation -->
    <Header />

    <!-- Main Content -->
    <main class="main_content">
      <slot />
    </main>

    <!-- Footer -->
    <Footer />

    <!-- Session Management -->
    <!-- Initialize Stratos Tracker (GDPR Compliant) -->
    <script>
      import { StratosTracker } from '../lib/stratos-tracker';
      import { initSession, hasAnalyticsConsent } from '../lib/session';

      // Create tracker instance (does NOT track yet - waits for consent)
      const tracker = new StratosTracker({
        apiUrl: import.meta.env.PUBLIC_SUPABASE_URL,
        apiKey: import.meta.env.PUBLIC_WEBSITE_API_KEY,
        trackingEnabled: true,
        debug: import.meta.env.DEV, // Debug in development only
      });

      // Make tracker globally available
      window.StratosTracker = tracker;

      // GDPR: Only initialize if consent already given (returning visitor)
      if (hasAnalyticsConsent()) {
        console.log('[GDPR] Analytics consent found - initializing tracker');
        initSession();
        tracker.init();
        tracker.trackPageView();
      } else {
        console.log('[GDPR] No analytics consent - tracker waiting for consent');
        // Tracker will auto-initialize when consent is given via cookieConsentUpdated event
      }
    </script>

    <!-- Cookie Consent -->
    <CookieConsent />
  </body>
</html>

<style lang="scss" is:global>
  // ========================================
  // GLOBAL STYLES
  // Uses token system for dynamic theming
  // ========================================

  @use '../styles/tokens' as tokens;

  // ========================================
  // GLOBAL RESETS
  // ========================================
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html {
    scroll-behavior: smooth;
  }

  body {
    font-family: var(--font-family-body);
    color: var(--color-text-primary);
    line-height: var(--line-height-base);
    background: var(--color-bg-primary);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  // ========================================
  // LAYOUT STRUCTURE
  // ========================================

  .body_wrapper {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    background: var(--color-bg-primary);
    padding-top: var(--header-height);

    @media (max-width: 768px) {
      padding-top: var(--header-height-mobile);
    }
  }

  .main_content {
    flex-grow: 1;
    width: 100%;
  }

  // ========================================
  // TYPOGRAPHY DEFAULTS
  // ========================================

  h1, h2, h3, h4, h5, h6 {
    font-family: var(--font-family-heading);
    font-weight: var(--font-weight-heading);
    line-height: var(--line-height-tight);
    color: var(--color-text-primary);
  }

  a {
    color: var(--color-primary);
    text-decoration: none;
    transition: color var(--transition-fast);

    &:hover {
      color: var(--color-primary-dark);
    }
  }

  // ========================================
  // FOCUS STYLES (Accessibility)
  // ========================================

  :focus-visible {
    outline: none;
    box-shadow: var(--focus-ring);
  }

  // ========================================
  // SELECTION STYLES
  // ========================================

  ::selection {
    background: var(--color-primary);
    color: var(--color-text-light);
  }
</style>