---
// ========================================
// HERO SEARCH BAR COMPONENT
// Simplified search for homepage hero sections
// Redirects to main search page with filters
// ========================================

interface Props {
  placeholder?: string
  showPropertyType?: boolean
  variant?: 'light' | 'dark'
  className?: string
}

const { 
  placeholder = "Enter location or postcode...",
  showPropertyType = true,
  variant = 'light',
  className = ''
} = Astro.props

// Price ranges for quick search
const priceRanges = [
  { value: '', label: 'Max Price' },
  { value: '150000', label: '£150k' },
  { value: '200000', label: '£200k' },
  { value: '250000', label: '£250k' },
  { value: '300000', label: '£300k' },
  { value: '400000', label: '£400k' },
  { value: '500000', label: '£500k' },
  { value: '750000', label: '£750k' },
  { value: '1000000', label: '£1M' },
  { value: '2000000', label: '£2M+' },
]

const propertyTypes = [
  { value: '', label: 'Property Type' },
  { value: 'detached', label: 'Detached' },
  { value: 'semi-detached', label: 'Semi-Detached' },
  { value: 'terraced', label: 'Terraced' },
  { value: 'flat', label: 'Flat/Apartment' },
  { value: 'bungalow', label: 'Bungalow' },
]
---

<div class={`hero-search-bar hero-search-${variant} ${className}`}>
  <form class="hero-search-form" id="hero-search-form">
    <!-- Hidden listing type - defaults to sale -->
    <input type="hidden" name="listing_type" value="sale" />

    <div class="search-grid">
      <!-- Location Input -->
      <div class="search-field location-field">
        <div class="field-wrapper">
          <svg class="field-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
          <input
            type="text"
            name="location"
            placeholder={placeholder}
            class="field-input"
            required
          />
        </div>
      </div>

      <!-- Max Price -->
      <div class="search-field price-field">
        <div class="field-wrapper">
          <svg class="field-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" x2="12" y1="2" y2="22"></line>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
          </svg>
          <select name="max_price" class="field-select">
            {priceRanges.map(range => (
              <option value={range.value}>{range.label}</option>
            ))}
          </select>
        </div>
      </div>

      <!-- Property Type (Optional) -->
      {showPropertyType && (
        <div class="search-field type-field">
          <div class="field-wrapper">
            <svg class="field-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            </svg>
            <select name="property_type" class="field-select">
              {propertyTypes.map(type => (
                <option value={type.value}>{type.label}</option>
              ))}
            </select>
          </div>
        </div>
      )}

      <!-- Search Button -->
      <button type="submit" class="search-button">
        <svg class="button-icon" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <span class="button-text">Search Properties</span>
      </button>
    </div>

    <!-- Quick Stats or Trust Indicators (Optional) -->
    <div class="search-meta">
      <p class="meta-text">
        <svg class="meta-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a2 2 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
        </svg>
        <span>Search thousands of properties across the UK</span>
      </p>
    </div>
  </form>
</div>

<style>
  .hero-search-bar {
    width: 100%;
    max-width: 900px;
    margin: 0 auto;
  }

  .hero-search-form {
    background: white;
    border-radius: 16px;
    padding: 0.75rem;
    box-shadow: 
      0 20px 60px rgba(0, 0, 0, 0.15),
      0 0 0 1px rgba(0, 0, 0, 0.05);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .hero-search-form:focus-within {
    box-shadow: 
      0 24px 80px rgba(0, 0, 0, 0.2),
      0 0 0 1px rgba(59, 130, 246, 0.3);
    transform: translateY(-2px);
  }

  /* Search Grid */
  .search-grid {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr auto;
    gap: 0.75rem;
    align-items: center;
  }

  /* Search Fields */
  .search-field {
    position: relative;
  }

  .field-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    background: #f9fafb;
    border: 2px solid transparent;
    border-radius: 12px;
    transition: all 0.2s ease;
    height: 56px;
  }

  .field-wrapper:focus-within {
    background: white;
    border-color: #3b82f6;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
  }

  .field-icon {
    position: absolute;
    left: 1rem;
    color: #9ca3af;
    pointer-events: none;
    z-index: 1;
    flex-shrink: 0;
  }

  .field-input,
  .field-select {
    width: 100%;
    height: 100%;
    padding: 0 1rem 0 3rem;
    background: transparent;
    border: none;
    font-size: 0.9375rem;
    font-weight: 500;
    color: #111827;
    outline: none;
  }

  .field-input::placeholder {
    color: #9ca3af;
    font-weight: 400;
  }

  .field-select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    padding-right: 3rem;
  }

  /* Search Button */
  .search-button {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.625rem;
    height: 56px;
    padding: 0 2rem;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 0.9375rem;
    font-weight: 700;
    white-space: nowrap;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);
  }

  .search-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(37, 99, 235, 0.35);
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  }

  .search-button:active {
    transform: translateY(0);
  }

  .button-icon {
    width: 22px;
    height: 22px;
    flex-shrink: 0;
  }

  .button-text {
    font-size: 1rem;
  }

  /* Search Meta */
  .search-meta {
    margin-top: 0.75rem;
    text-align: center;
  }

  .meta-text {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8125rem;
    color: #6b7280;
    margin: 0;
  }

  .meta-icon {
    color: #9ca3af;
    flex-shrink: 0;
  }

  /* Dark Variant */
  .hero-search-dark .hero-search-form {
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(12px);
  }

  .hero-search-dark .field-wrapper {
    background: rgba(249, 250, 251, 0.95);
  }

  .hero-search-dark .field-wrapper:focus-within {
    background: white;
  }

  .hero-search-dark .meta-text {
    color: rgba(255, 255, 255, 0.9);
  }

  .hero-search-dark .meta-icon {
    color: rgba(255, 255, 255, 0.7);
  }

  /* Responsive Breakpoints */
  @media (max-width: 1024px) {
    .search-grid {
      grid-template-columns: 1fr 1fr 1fr;
    }

    .location-field {
      grid-column: 1 / -1;
    }

    .search-button {
      grid-column: 1 / -1;
    }
  }

  @media (max-width: 640px) {
    .hero-search-form {
      padding: 0.625rem;
    }

    .search-grid {
      grid-template-columns: 1fr;
      gap: 0.625rem;
    }

    .field-wrapper {
      height: 52px;
    }

    .search-button {
      height: 52px;
      padding: 0 1.5rem;
    }

    .button-text {
      font-size: 0.9375rem;
    }

    .button-icon {
      width: 20px;
      height: 20px;
    }

    .search-meta {
      margin-top: 0.625rem;
    }

    .meta-text {
      font-size: 0.75rem;
    }
  }

  @media (max-width: 480px) {
    .button-text {
      display: none;
    }

    .search-button {
      padding: 0 1.25rem;
    }
  }

  /* Focus/Hover Animations */
  @keyframes pulse-ring {
    0% {
      box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
    }
    70% {
      box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
    }
  }

  .field-wrapper:focus-within {
    animation: pulse-ring 1.5s ease-out;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const heroForm = document.getElementById('hero-search-form') as HTMLFormElement
    
    if (!heroForm) return

    // ✅ TRACKING: Track hero search interactions
    const trackHeroSearch = (eventName: string, data: any) => {
      if (window.StratosTracker) {
        window.StratosTracker.trackEvent(eventName, data)
      }
    }

    // Track when user starts typing
    const locationInput = heroForm.querySelector('input[name="location"]') as HTMLInputElement
    if (locationInput) {
      locationInput.addEventListener('focus', () => {
        // Don't track focus - not a standard event type
      }, { once: true })
    }

    // Track filter selections
    const selects = heroForm.querySelectorAll('select')
    selects.forEach(select => {
      select.addEventListener('change', (e) => {
        const target = e.target as HTMLSelectElement
        trackHeroSearch('filter_change', {
          filter_name: target.name,
          filter_value: target.value,
          component: 'hero_search_bar'
        })
      })
    })

    // ✅ CLEAN URL HANDLING: Only include non-empty parameters
    heroForm.addEventListener('submit', (e) => {
      e.preventDefault()
      
      const formData = new FormData(heroForm)
      const urlParams = new URLSearchParams()
      const searchParams: Record<string, any> = {}
      
      // Only add non-empty values
      formData.forEach((value, key) => {
        const stringValue = value.toString().trim()
        
        if (stringValue) {
          urlParams.append(key, stringValue)
          searchParams[key] = stringValue
        }
      })

      // Track hero search submission
      trackHeroSearch('search', {
        listing_type: searchParams.listing_type || 'sale',
        location: searchParams.location || '',
        filters_count: Object.keys(searchParams).length,
        component: 'hero_search_bar'
      })

      // Navigate to main search page with clean URL
      const cleanUrl = `/search?${urlParams.toString()}`
      window.location.href = cleanUrl
    })

    console.log('✅ Hero search bar initialized')
  })
</script>