---
// ========================================
// LUXURY SEARCH BAR DESIGN
// Uses SearchBarCore for logic
// Implements premium gold/dark design
// ========================================

import SearchBarCore from './SearchBarCore.astro'
import type { SearchBarConfig } from './SearchBarCore.astro'

interface Props extends SearchBarConfig {
  theme?: 'dark' | 'light'
}

const { theme = 'dark', ...coreConfig } = Astro.props
---

<SearchBarCore config={coreConfig}>
  <form class={`luxury-search theme-${theme}`} data-search-form>
    <div class="luxury-header">
      <h3 class="luxury-title">Find Your Exclusive Property</h3>
      <p class="luxury-subtitle">Premium homes in prime locations</p>
    </div>
    
    {/* Listing Type Toggle */}
    {coreConfig.fields.listingType && (
      <div class="listing-type-toggle">
        <label class="toggle-option" data-value="sale">
          <input
            type="radio"
            name="listing_type"
            value="sale"
            checked={coreConfig.currentParams?.listing_type !== 'let'}
            class="toggle-input"
          />
          <span class="toggle-content">
            <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            </svg>
            <span class="toggle-text">Buy</span>
          </span>
        </label>
        
        <label class="toggle-option" data-value="let">
          <input
            type="radio"
            name="listing_type"
            value="let"
            checked={coreConfig.currentParams?.listing_type === 'let'}
            class="toggle-input"
          />
          <span class="toggle-content">
            <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect width="18" height="18" x="3" y="3" rx="2"></rect>
              <path d="M9 3v18"></path>
              <path d="M15 3v18"></path>
            </svg>
            <span class="toggle-text">Rent</span>
          </span>
        </label>
      </div>
    )}
    
    <div class="search-fields">
      {coreConfig.fields.location && (
        <div class="luxury-field">
          <input
            type="text"
            name="location"
            value={coreConfig.currentParams?.location || ''}
            placeholder="London, Chelsea, Mayfair..."
            class="luxury-input"
          />
          <span class="field-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
          </span>
        </div>
      )}
      
      {coreConfig.fields.minPrice && (
        <div class="luxury-field">
          <select name="min_price" class="luxury-select" id="min_price_select">
            <!-- Options will be populated by JavaScript based on listing type -->
          </select>
        </div>
      )}
      
      {coreConfig.fields.maxPrice && (
        <div class="luxury-field">
          <select name="max_price" class="luxury-select" id="max_price_select">
            <!-- Options will be populated by JavaScript based on listing type -->
          </select>
        </div>
      )}
    </div>
    
    <button type="submit" class="luxury-btn">
      <span class="btn-shimmer"></span>
      <span class="btn-text">Explore Premium Properties</span>
      <svg class="btn-arrow" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="5" x2="19" y1="12" y2="12"></line>
        <polyline points="12 5 19 12 12 19"></polyline>
      </svg>
    </button>
  </form>
</SearchBarCore>

<style>
  .luxury-search {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    padding: 2.5rem 2rem;
    border-radius: 24px;
    border: 2px solid rgba(212, 175, 55, 0.3);
    box-shadow: 
      0 30px 90px rgba(0, 0, 0, 0.5),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    position: relative;
    overflow: hidden;
  }
  
  .luxury-search::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(212, 175, 55, 0.8),
      transparent
    );
  }
  
  .luxury-header {
    text-align: center;
    margin-bottom: 2rem;
  }
  
  .luxury-title {
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    font-weight: 700;
    background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 50%, #d4af37 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin: 0 0 0.5rem 0;
  }
  
  .luxury-subtitle {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9375rem;
    font-weight: 300;
    letter-spacing: 0.5px;
    margin: 0;
  }
  
  /* Listing Type Toggle */
  .listing-type-toggle {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    padding: 0.5rem;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 16px;
    border: 1px solid rgba(212, 175, 55, 0.2);
  }
  
  .toggle-option {
    flex: 1;
    cursor: pointer;
    position: relative;
  }
  
  .toggle-input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }
  
  .toggle-content {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.625rem;
    padding: 1rem 1.5rem;
    background: transparent;
    border-radius: 12px;
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.9375rem;
    font-weight: 600;
    letter-spacing: 0.3px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid transparent;
  }
  
  .toggle-icon {
    width: 18px;
    height: 18px;
    transition: all 0.3s ease;
  }
  
  .toggle-text {
    font-weight: 700;
  }
  
  /* Active state */
  .toggle-input:checked + .toggle-content {
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.25) 0%, rgba(212, 175, 55, 0.15) 100%);
    color: #d4af37;
    border-color: rgba(212, 175, 55, 0.5);
    box-shadow: 
      0 4px 12px rgba(212, 175, 55, 0.2),
      inset 0 1px 0 rgba(212, 175, 55, 0.3);
  }
  
  .toggle-input:checked + .toggle-content .toggle-icon {
    color: #d4af37;
    filter: drop-shadow(0 0 8px rgba(212, 175, 55, 0.5));
  }
  
  /* Hover state */
  .toggle-option:hover .toggle-content {
    background: rgba(212, 175, 55, 0.1);
    color: rgba(255, 255, 255, 0.9);
    border-color: rgba(212, 175, 55, 0.3);
  }
  
  .toggle-option:hover .toggle-input:checked + .toggle-content {
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.3) 0%, rgba(212, 175, 55, 0.2) 100%);
    transform: translateY(-2px);
  }
  
  .search-fields {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .luxury-field {
    position: relative;
  }
  
  .luxury-input,
  .luxury-select {
    width: 100%;
    padding: 1rem 1.25rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(212, 175, 55, 0.2);
    border-radius: 12px;
    color: white;
    font-size: 0.9375rem;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
  }
  
  .luxury-input::placeholder {
    color: rgba(255, 255, 255, 0.4);
  }
  
  .luxury-input:focus,
  .luxury-select:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(212, 175, 55, 0.6);
    box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.1);
  }
  
  .luxury-select {
    appearance: none;
    cursor: pointer;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23d4af37' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    padding-right: 3rem;
  }
  
  .field-icon {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: rgba(212, 175, 55, 0.6);
    pointer-events: none;
  }
  
  .luxury-btn {
    position: relative;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 1.25rem 2rem;
    background: linear-gradient(135deg, #d4af37 0%, #b8941f 100%);
    color: #1a1a1a;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 700;
    letter-spacing: 0.5px;
    cursor: pointer;
    overflow: hidden;
    transition: all 0.3s ease;
  }
  
  .btn-shimmer {
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.3),
      transparent
    );
    animation: shimmer 3s infinite;
  }
  
  @keyframes shimmer {
    0% { left: -100%; }
    50%, 100% { left: 100%; }
  }
  
  .btn-text {
    position: relative;
    z-index: 1;
  }
  
  .btn-arrow {
    position: relative;
    z-index: 1;
    transition: transform 0.3s ease;
  }
  
  .luxury-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 40px rgba(212, 175, 55, 0.4);
  }
  
  .luxury-btn:hover .btn-arrow {
    transform: translateX(5px);
  }
  
  /* Light Theme */
  .theme-light {
    background: linear-gradient(135deg, #fafafa 0%, #ffffff 100%);
    border-color: rgba(212, 175, 55, 0.4);
  }
  
  .theme-light .luxury-title {
    background: linear-gradient(135deg, #b8941f 0%, #d4af37 50%, #b8941f 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .theme-light .luxury-subtitle {
    color: #6b7280;
  }
  
  .theme-light .luxury-input,
  .theme-light .luxury-select {
    background: white;
    border-color: #e5e7eb;
    color: #111827;
  }
  
  .theme-light .luxury-input::placeholder {
    color: #9ca3af;
  }
  
  /* Light Theme - Listing Type Toggle */
  .theme-light .listing-type-toggle {
    background: #f9fafb;
    border-color: #e5e7eb;
  }
  
  .theme-light .toggle-content {
    color: #6b7280;
  }
  
  .theme-light .toggle-input:checked + .toggle-content {
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.15) 0%, rgba(212, 175, 55, 0.08) 100%);
    color: #b8941f;
    border-color: rgba(212, 175, 55, 0.4);
    box-shadow: 
      0 2px 8px rgba(212, 175, 55, 0.15),
      inset 0 1px 0 rgba(212, 175, 55, 0.2);
  }
  
  .theme-light .toggle-input:checked + .toggle-content .toggle-icon {
    color: #b8941f;
    filter: drop-shadow(0 0 4px rgba(212, 175, 55, 0.3));
  }
  
  .theme-light .toggle-option:hover .toggle-content {
    background: rgba(212, 175, 55, 0.08);
    color: #374151;
    border-color: rgba(212, 175, 55, 0.2);
  }
  
  @media (max-width: 768px) {
    .luxury-search {
      padding: 1.5rem 1.25rem;
    }
    
    .luxury-title {
      font-size: 1.5rem;
    }
    
    .listing-type-toggle {
      margin-bottom: 1.5rem;
    }
    
    .toggle-content {
      padding: 0.875rem 1rem;
      font-size: 0.875rem;
    }
    
    .toggle-icon {
      width: 16px;
      height: 16px;
    }
    
    .search-fields {
      grid-template-columns: 1fr;
    }
  }
</style>

<script define:vars={{ currentListingType: coreConfig.currentParams?.listing_type || 'sale', currentMinPrice: coreConfig.currentParams?.min_price || '', currentMaxPrice: coreConfig.currentParams?.max_price || '' }}>
  // Price options for sale properties
  const salePrices = {
    min: [
      { value: '', label: 'Min Price' },
      { value: '500000', label: '£500k' },
      { value: '1000000', label: '£1M' },
      { value: '2000000', label: '£2M' },
      { value: '5000000', label: '£5M' },
      { value: '10000000', label: '£10M' },
      { value: '15000000', label: '£15M' },
    ],
    max: [
      { value: '', label: 'Max Price' },
      { value: '1000000', label: '£1M' },
      { value: '2000000', label: '£2M' },
      { value: '5000000', label: '£5M' },
      { value: '10000000', label: '£10M' },
      { value: '20000000', label: '£20M' },
      { value: '50000000', label: '£50M+' },
    ]
  }

  // Price options for rental properties
  const rentPrices = {
    min: [
      { value: '', label: 'Min Rent' },
      { value: '1000', label: '£1,000 pcm' },
      { value: '2000', label: '£2,000 pcm' },
      { value: '3000', label: '£3,000 pcm' },
      { value: '5000', label: '£5,000 pcm' },
      { value: '7500', label: '£7,500 pcm' },
      { value: '10000', label: '£10,000 pcm' },
    ],
    max: [
      { value: '', label: 'Max Rent' },
      { value: '2000', label: '£2,000 pcm' },
      { value: '3000', label: '£3,000 pcm' },
      { value: '5000', label: '£5,000 pcm' },
      { value: '7500', label: '£7,500 pcm' },
      { value: '10000', label: '£10,000 pcm' },
      { value: '15000', label: '£15,000+ pcm' },
    ]
  }

  function updatePriceDropdowns(listingType, preserveValues = false) {
    const minPriceSelect = document.getElementById('min_price_select')
    const maxPriceSelect = document.getElementById('max_price_select')
    
    if (!minPriceSelect && !maxPriceSelect) return
    
    const prices = listingType === 'let' ? rentPrices : salePrices
    
    // Store current values if preserving
    const currentMin = preserveValues ? minPriceSelect?.value : ''
    const currentMax = preserveValues ? maxPriceSelect?.value : ''
    
    // Update min price dropdown
    if (minPriceSelect) {
      minPriceSelect.innerHTML = ''
      prices.min.forEach(price => {
        const option = document.createElement('option')
        option.value = price.value
        option.textContent = price.label
        // Re-select if value exists in new list
        if (preserveValues && price.value === currentMin) {
          option.selected = true
        }
        minPriceSelect.appendChild(option)
      })
    }
    
    // Update max price dropdown
    if (maxPriceSelect) {
      maxPriceSelect.innerHTML = ''
      prices.max.forEach(price => {
        const option = document.createElement('option')
        option.value = price.value
        option.textContent = price.label
        // Re-select if value exists in new list
        if (preserveValues && price.value === currentMax) {
          option.selected = true
        }
        maxPriceSelect.appendChild(option)
      })
    }
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('.luxury-search[data-search-form]')
    if (!form) return
    
    // Set initial listing type
    const initialListingType = currentListingType
    updatePriceDropdowns(initialListingType, false)
    
    // Set current values from URL if they exist
    const minPriceSelect = document.getElementById('min_price_select')
    const maxPriceSelect = document.getElementById('max_price_select')
    
    if (minPriceSelect && currentMinPrice) {
      minPriceSelect.value = currentMinPrice
    }
    
    if (maxPriceSelect && currentMaxPrice) {
      maxPriceSelect.value = currentMaxPrice
    }
    
    // Listen for listing type changes
    const listingTypeInputs = form.querySelectorAll('input[name="listing_type"]')
    listingTypeInputs.forEach(input => {
      input.addEventListener('change', (e) => {
        const newListingType = e.target.value
        updatePriceDropdowns(newListingType, false)
        
        // Track the change
        if (window.StratosTracker) {
          window.StratosTracker.trackEvent('luxury_search_listing_type_change', {
            listing_type: newListingType,
            prices_updated: true
          })
        }
      })
    })
    
    console.log('✅ Luxury search bar initialized with dynamic prices')
  })
</script>