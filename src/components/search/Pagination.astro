---
// ========================================
// PAGINATION COMPONENT
// Production-ready page navigation for search results
// ========================================

import { buildSearchUrl } from '../../lib/utils'
import type { PropertySearchParams } from '../../types/database'

interface Props {
  currentPage: number
  totalPages: number
  totalResults: number
  searchParams: PropertySearchParams
  class?: string
}

const {
  currentPage,
  totalPages,
  totalResults,
  searchParams,
  class: className = '',
} = Astro.props

// ----------------------------------------
// URL GENERATION
// ----------------------------------------

function getPageUrl(page: number): string {
  return buildSearchUrl({ ...searchParams, page })
}

// ----------------------------------------
// PAGE RANGE CALCULATION
// ----------------------------------------

const maxPagesToShow = 5
const halfRange = Math.floor(maxPagesToShow / 2)

let startPage = Math.max(1, currentPage - halfRange)
let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1)

// Adjust start if we're near the end
if (endPage - startPage < maxPagesToShow - 1) {
  startPage = Math.max(1, endPage - maxPagesToShow + 1)
}

const pages = Array.from(
  { length: endPage - startPage + 1 },
  (_, i) => startPage + i
)

// ----------------------------------------
// NAVIGATION STATE
// ----------------------------------------

const hasNext = currentPage < totalPages
const hasPrev = currentPage > 1
const showFirstPage = startPage > 1
const showLastPage = endPage < totalPages
const showFirstEllipsis = startPage > 2
const showLastEllipsis = endPage < totalPages - 1

// ----------------------------------------
// RESULTS RANGE
// ----------------------------------------

const limit = searchParams.limit || 20
const startResult = (currentPage - 1) * limit + 1
const endResult = Math.min(currentPage * limit, totalResults)
---

{totalPages > 1 && (
  <nav
    class:list={['pagination', className]}
    aria-label="Search results pagination"
    role="navigation"
  >
    <!-- Results Summary -->
    <div class="pagination__info">
      <span class="pagination__info-text">
        Showing <strong>{startResult.toLocaleString()}</strong> - <strong>{endResult.toLocaleString()}</strong> of <strong>{totalResults.toLocaleString()}</strong>
      </span>
    </div>

    <!-- Navigation Controls -->
    <div class="pagination__controls">
      <!-- Previous Button -->
      {hasPrev ? (
        <a
          href={getPageUrl(currentPage - 1)}
          class="pagination__btn pagination__btn--prev"
          aria-label="Go to previous page"
        >
          <svg class="pagination__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
          <span class="pagination__btn-text">Previous</span>
        </a>
      ) : (
        <span class="pagination__btn pagination__btn--prev pagination__btn--disabled" aria-disabled="true">
          <svg class="pagination__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
          <span class="pagination__btn-text">Previous</span>
        </span>
      )}

      <!-- Page Numbers -->
      <div class="pagination__pages">
        <!-- First Page -->
        {showFirstPage && (
          <>
            <a
              href={getPageUrl(1)}
              class="pagination__page"
              aria-label="Go to page 1"
            >
              1
            </a>
            {showFirstEllipsis && (
              <span class="pagination__ellipsis" aria-hidden="true">...</span>
            )}
          </>
        )}

        <!-- Page Range -->
        {pages.map(page => (
          page === currentPage ? (
            <span
              class="pagination__page pagination__page--current"
              aria-label={`Page ${page}, current page`}
              aria-current="page"
            >
              {page}
            </span>
          ) : (
            <a
              href={getPageUrl(page)}
              class="pagination__page"
              aria-label={`Go to page ${page}`}
            >
              {page}
            </a>
          )
        ))}

        <!-- Last Page -->
        {showLastPage && (
          <>
            {showLastEllipsis && (
              <span class="pagination__ellipsis" aria-hidden="true">...</span>
            )}
            <a
              href={getPageUrl(totalPages)}
              class="pagination__page"
              aria-label={`Go to page ${totalPages}`}
            >
              {totalPages}
            </a>
          </>
        )}
      </div>

      <!-- Next Button -->
      {hasNext ? (
        <a
          href={getPageUrl(currentPage + 1)}
          class="pagination__btn pagination__btn--next"
          aria-label="Go to next page"
        >
          <span class="pagination__btn-text">Next</span>
          <svg class="pagination__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </a>
      ) : (
        <span class="pagination__btn pagination__btn--next pagination__btn--disabled" aria-disabled="true">
          <span class="pagination__btn-text">Next</span>
          <svg class="pagination__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </span>
      )}
    </div>

    <!-- Mobile Page Indicator -->
    <div class="pagination__mobile-info">
      Page {currentPage} of {totalPages}
    </div>
  </nav>
)}

<style lang="scss">
  @use '../../styles/variables' as *;
  @use '../../styles/mixins' as *;

  // ----------------------------------------
  // CONTAINER
  // ----------------------------------------

  .pagination {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: $spacing-4;
    padding: $spacing-6;
    background: $bg-white;
    border-radius: $radius-xl;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    border: 1px solid $border-light;

    @include md {
      flex-direction: row;
      justify-content: space-between;
      gap: $spacing-6;
    }
  }

  // ----------------------------------------
  // RESULTS INFO
  // ----------------------------------------

  .pagination__info {
    display: none;

    @include md {
      display: block;
      flex-shrink: 0;
    }
  }

  .pagination__info-text {
    font-size: $font-size-sm;
    color: $text-secondary;

    strong {
      color: $text-primary;
      font-weight: $font-weight-semibold;
    }
  }

  // ----------------------------------------
  // CONTROLS CONTAINER
  // ----------------------------------------

  .pagination__controls {
    display: flex;
    align-items: center;
    gap: $spacing-2;

    @include md {
      gap: $spacing-3;
    }
  }

  // ----------------------------------------
  // PREV/NEXT BUTTONS
  // ----------------------------------------

  .pagination__btn {
    display: inline-flex;
    align-items: center;
    gap: $spacing-2;
    padding: $spacing-2 $spacing-4;
    font-size: $font-size-sm;
    font-weight: $font-weight-medium;
    color: $text-primary;
    background: $bg-white;
    border: 1px solid $border-light;
    border-radius: $radius-md;
    text-decoration: none;
    cursor: pointer;
    transition: all $transition-fast;
    white-space: nowrap;

    &:hover:not(.pagination__btn--disabled) {
      border-color: $accent-coral;
      color: $accent-coral;
      background: rgba($accent-coral, 0.04);
    }

    &:focus:not(.pagination__btn--disabled) {
      outline: none;
      border-color: $accent-coral;
      box-shadow: 0 0 0 3px rgba($accent-coral, 0.15);
    }

    &:active:not(.pagination__btn--disabled) {
      transform: translateY(1px);
    }
  }

  .pagination__btn--disabled {
    color: $text-muted;
    background: $bg-off-white;
    border-color: $border-light;
    cursor: not-allowed;
    opacity: 0.6;
  }

  .pagination__btn-text {
    display: none;

    @include sm {
      display: inline;
    }
  }

  .pagination__icon {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
  }

  // ----------------------------------------
  // PAGE NUMBERS
  // ----------------------------------------

  .pagination__pages {
    display: flex;
    align-items: center;
    gap: $spacing-1;
  }

  .pagination__page {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 40px;
    height: 40px;
    padding: 0 $spacing-3;
    font-size: $font-size-sm;
    font-weight: $font-weight-medium;
    color: $text-primary;
    background: $bg-white;
    border: 1px solid $border-light;
    border-radius: $radius-md;
    text-decoration: none;
    transition: all $transition-fast;

    &:hover:not(.pagination__page--current) {
      border-color: $accent-coral;
      color: $accent-coral;
      background: rgba($accent-coral, 0.04);
    }

    &:focus:not(.pagination__page--current) {
      outline: none;
      border-color: $accent-coral;
      box-shadow: 0 0 0 3px rgba($accent-coral, 0.15);
    }

    // Hide some pages on mobile
    @media (max-width: 480px) {
      &:not(.pagination__page--current):not(:first-child):not(:last-child) {
        display: none;
      }
    }
  }

  .pagination__page--current {
    color: $bg-white;
    background: $accent-coral;
    border-color: $accent-coral;
    cursor: default;
    font-weight: $font-weight-bold;
  }

  .pagination__ellipsis {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 32px;
    height: 40px;
    font-size: $font-size-sm;
    color: $text-muted;
    letter-spacing: 2px;

    @media (max-width: 480px) {
      display: none;
    }
  }

  // ----------------------------------------
  // MOBILE INFO
  // ----------------------------------------

  .pagination__mobile-info {
    display: block;
    font-size: $font-size-sm;
    color: $text-secondary;
    font-weight: $font-weight-medium;

    @include md {
      display: none;
    }
  }
</style>
