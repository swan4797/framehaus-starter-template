---
interface Props {
  inline?: boolean; // For inline versions (e.g., footer)
}

const { inline = false } = Astro.props;
---

<div class={inline ? 'newsletter-inline' : 'form-container'}>
  <form id="newsletter-form" class={inline ? 'newsletter-form-inline' : 'enquiry-form'}>
    {!inline && (
      <>
        <h2 class="form-title">Stay Updated</h2>
        <p class="form-description">
          Subscribe to our newsletter and be the first to know about new properties and market insights.
        </p>
      </>
    )}

    {inline && (
      <h3 class="newsletter-title">Property Updates</h3>
    )}

    <div class={inline ? 'newsletter-row' : 'form-row'}>
      <div class="form-group">
        <label for="newsletter-name" class="form-label" style={inline ? 'display: none;' : ''}>
          First Name <span class="required">*</span>
        </label>
        <input
          type="text"
          id="newsletter-name"
          name="first_name"
          class="form-input"
          required
          placeholder="First name"
        />
      </div>

      <div class="form-group">
        <label for="newsletter-email" class="form-label" style={inline ? 'display: none;' : ''}>
          Email Address <span class="required">*</span>
        </label>
        <input
          type="email"
          id="newsletter-email"
          name="email"
          class="form-input"
          required
          placeholder="your@email.com"
        />
      </div>
    </div>

    {!inline && (
      <div class="form-group">
        <label class="form-label">I'm interested in:</label>
        <div class="checkbox-group">
          <label class="form-checkbox">
            <input type="checkbox" name="interests" value="sales" checked />
            <span>Properties for Sale</span>
          </label>
          <label class="form-checkbox">
            <input type="checkbox" name="interests" value="lettings" checked />
            <span>Properties to Let</span>
          </label>
          <label class="form-checkbox">
            <input type="checkbox" name="interests" value="market_updates" checked />
            <span>Market Updates & News</span>
          </label>
        </div>
      </div>
    )}

    <div class="form-group">
      <label class="form-checkbox">
        <input type="checkbox" name="gdpr_consent" required />
        <span>
          I agree to the <a href="/privacy-policy" target="_blank">Privacy Policy</a>
          <span class="required">*</span>
        </span>
      </label>
    </div>

    <div id="newsletter-error" class="form-error" style="display: none;"></div>
    <div id="newsletter-success" class="form-success" style="display: none;">
      Thank you for subscribing! Check your email to confirm your subscription.
    </div>

    <button type="submit" class={inline ? 'newsletter-submit' : 'form-submit'} id="newsletter-submit">
      Subscribe
    </button>
  </form>
</div>

<style>
  .form-container {
    max-width: 600px;
    margin: 0 auto;
  }

  .enquiry-form {
    background: #ffffff;
    padding: 2rem;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .form-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0 0 0.5rem 0;
    color: #1a1a1a;
  }

  .form-description {
    font-size: 0.875rem;
    color: #6b7280;
    margin: 0 0 1.5rem 0;
  }

  /* Inline newsletter styles (for footer) */
  .newsletter-inline {
    width: 100%;
  }

  .newsletter-form-inline {
    background: transparent;
  }

  .newsletter-title {
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0 0 1rem 0;
    color: #1a1a1a;
  }

  .newsletter-row {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
  }

  .newsletter-submit {
    width: 100%;
    background: #2563eb;
    color: #ffffff;
    padding: 0.625rem 1rem;
    border: none;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
  }

  .newsletter-submit:hover {
    background: #1d4ed8;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  @media (min-width: 640px) {
    .form-row {
      grid-template-columns: 1fr 1fr;
    }
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: #374151;
  }

  .required {
    color: #dc2626;
  }

  .checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-input {
    width: 100%;
    padding: 0.625rem 0.875rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    transition: border-color 0.2s;
  }

  .form-input:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .form-checkbox {
    display: flex;
    align-items: start;
    gap: 0.5rem;
    font-size: 0.875rem;
    cursor: pointer;
  }

  .form-checkbox input[type="checkbox"] {
    margin-top: 0.125rem;
    flex-shrink: 0;
  }

  .form-checkbox a {
    color: #2563eb;
    text-decoration: underline;
  }

  .form-error {
    background: #fee2e2;
    color: #991b1b;
    padding: 0.75rem;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
    font-size: 0.875rem;
  }

  .form-success {
    background: #d1fae5;
    color: #065f46;
    padding: 0.75rem;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
    font-size: 0.875rem;
  }

  .form-submit {
    width: 100%;
    background: #2563eb;
    color: #ffffff;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 0.375rem;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
  }

  .form-submit:hover {
    background: #1d4ed8;
  }

  .form-submit:disabled,
  .newsletter-submit:disabled {
    background: #9ca3af;
    cursor: not-allowed;
  }
</style>

<script>
  const form = document.getElementById('newsletter-form') as HTMLFormElement;
  const submitBtn = document.getElementById('newsletter-submit') as HTMLButtonElement;
  const errorDiv = document.getElementById('newsletter-error') as HTMLDivElement;
  const successDiv = document.getElementById('newsletter-success') as HTMLDivElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';

    submitBtn.disabled = true;
    submitBtn.textContent = 'Subscribing...';

    try {
      const sessionData = localStorage.getItem('stratos_session');
      const sessionId = sessionData ? JSON.parse(sessionData).sessionId : null;

      const formData = new FormData(form);
      const data: any = {
        enquiry_type: 'newsletter',
        session_id: sessionId,
        interests: [],
      };

      formData.forEach((value, key) => {
        if (key === 'gdpr_consent') {
          data[key] = value === 'true';
        } else if (key === 'interests') {
          data[key].push(value);
        } else {
          data[key] = value;
        }
      });

      // Default interests if none selected
      if (data.interests.length === 0) {
        data.interests = ['sales', 'lettings', 'market_updates'];
      }

      const apiKey = import.meta.env.PUBLIC_STRATOS_API_KEY;
      const apiEndpoint = import.meta.env.PUBLIC_STRATOS_API_ENDPOINT;

      const response = await fetch(`${apiEndpoint}/enquiry`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-API-Key': apiKey,
        },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        throw new Error('Failed to subscribe');
      }

      successDiv.style.display = 'block';
      form.reset();
      successDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

    } catch (error) {
      console.error('Form submission error:', error);
      errorDiv.textContent = 'There was an error subscribing. Please try again.';
      errorDiv.style.display = 'block';
      
      submitBtn.disabled = false;
      submitBtn.textContent = 'Subscribe';
    }
  });
</script>