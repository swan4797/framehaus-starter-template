---
interface Props {
  propertyId?: string;
  propertyAddress?: string;
}

const { propertyId, propertyAddress } = Astro.props;
---

<div class="form-container">
  <form id="viewing-form" class="enquiry-form">
    <h2 class="form-title">Request a Viewing</h2>
    
    {propertyAddress && (
      <div class="property-info">
        <strong>Property:</strong> {propertyAddress}
      </div>
    )}

    <input type="hidden" name="property_id" value={propertyId} />
    <input type="hidden" name="property_address" value={propertyAddress} />

    <div class="form-row">
      <div class="form-group">
        <label for="viewing-name" class="form-label">
          Full Name <span class="required">*</span>
        </label>
        <input
          type="text"
          id="viewing-name"
          name="name"
          class="form-input"
          required
          placeholder="John Smith"
        />
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="viewing-email" class="form-label">
          Email Address <span class="required">*</span>
        </label>
        <input
          type="email"
          id="viewing-email"
          name="email"
          class="form-input"
          required
          placeholder="john.smith@example.com"
        />
      </div>

      <div class="form-group">
        <label for="viewing-phone" class="form-label">
          Phone Number <span class="required">*</span>
        </label>
        <input
          type="tel"
          id="viewing-phone"
          name="phone"
          class="form-input"
          required
          placeholder="07700 900000"
        />
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="viewing-date" class="form-label">
          Preferred Date <span class="required">*</span>
        </label>
        <input
          type="date"
          id="viewing-date"
          name="preferred_date"
          class="form-input"
          required
          min={new Date().toISOString().split('T')[0]}
        />
      </div>

      <div class="form-group">
        <label for="viewing-time" class="form-label">
          Preferred Time <span class="required">*</span>
        </label>
        <select id="viewing-time" name="preferred_time" class="form-input" required>
          <option value="">Select a time</option>
          <option value="09:00">9:00 AM</option>
          <option value="10:00">10:00 AM</option>
          <option value="11:00">11:00 AM</option>
          <option value="12:00">12:00 PM</option>
          <option value="13:00">1:00 PM</option>
          <option value="14:00">2:00 PM</option>
          <option value="15:00">3:00 PM</option>
          <option value="16:00">4:00 PM</option>
          <option value="17:00">5:00 PM</option>
          <option value="18:00">6:00 PM</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label for="viewing-message" class="form-label">
        Additional Message
      </label>
      <textarea
        id="viewing-message"
        name="message"
        class="form-textarea"
        rows="4"
        placeholder="Any specific requirements or questions..."
      ></textarea>
    </div>

    <div class="form-group">
      <label class="form-checkbox">
        <input type="checkbox" name="marketing_opt_in" value="true" />
        <span>I would like to receive property updates and marketing communications</span>
      </label>
    </div>

    <div class="form-group">
      <label class="form-checkbox">
        <input type="checkbox" name="gdpr_consent" required />
        <span>
          I agree to the <a href="/privacy-policy" target="_blank">Privacy Policy</a> 
          and consent to my data being processed for this enquiry <span class="required">*</span>
        </span>
      </label>
    </div>

    <div id="viewing-error" class="form-error" style="display: none;"></div>
    <div id="viewing-success" class="form-success" style="display: none;">
      Thank you! Your viewing request has been submitted. We'll be in touch shortly.
    </div>

    <button type="submit" class="form-submit" id="viewing-submit">
      Request Viewing
    </button>
  </form>
</div>

<style>
  .form-container {
    max-width: 600px;
    margin: 0 auto;
  }

  .enquiry-form {
    background: #ffffff;
    padding: 2rem;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .form-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0 0 1.5rem 0;
    color: #1a1a1a;
  }

  .property-info {
    background: #f3f4f6;
    padding: 1rem;
    border-radius: 0.375rem;
    margin-bottom: 1.5rem;
    font-size: 0.875rem;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  @media (min-width: 640px) {
    .form-row {
      grid-template-columns: 1fr 1fr;
    }
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: #374151;
  }

  .required {
    color: #dc2626;
  }

  .form-input,
  .form-textarea {
    width: 100%;
    padding: 0.625rem 0.875rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    transition: border-color 0.2s;
  }

  .form-input:focus,
  .form-textarea:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .form-textarea {
    resize: vertical;
  }

  .form-checkbox {
    display: flex;
    align-items: start;
    gap: 0.5rem;
    font-size: 0.875rem;
    cursor: pointer;
  }

  .form-checkbox input[type="checkbox"] {
    margin-top: 0.125rem;
    flex-shrink: 0;
  }

  .form-checkbox a {
    color: #2563eb;
    text-decoration: underline;
  }

  .form-error {
    background: #fee2e2;
    color: #991b1b;
    padding: 0.75rem;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
    font-size: 0.875rem;
  }

  .form-success {
    background: #d1fae5;
    color: #065f46;
    padding: 0.75rem;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
    font-size: 0.875rem;
  }

  .form-submit {
    width: 100%;
    background: #2563eb;
    color: #ffffff;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 0.375rem;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
  }

  .form-submit:hover {
    background: #1d4ed8;
  }

  .form-submit:disabled {
    background: #9ca3af;
    cursor: not-allowed;
  }
</style>

<script>
  const form = document.getElementById('viewing-form') as HTMLFormElement;
  const submitBtn = document.getElementById('viewing-submit') as HTMLButtonElement;
  const errorDiv = document.getElementById('viewing-error') as HTMLDivElement;
  const successDiv = document.getElementById('viewing-success') as HTMLDivElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Clear previous messages
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';

    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    try {
      // Get session ID from localStorage
      const sessionData = localStorage.getItem('stratos_session');
      const sessionId = sessionData ? JSON.parse(sessionData).sessionId : null;

      // Collect form data
      const formData = new FormData(form);
      const data: any = {
        enquiry_type: 'viewing',
        session_id: sessionId,
      };

      // Convert FormData to object
      formData.forEach((value, key) => {
        if (key === 'marketing_opt_in' || key === 'gdpr_consent') {
          data[key] = value === 'true';
        } else {
          data[key] = value;
        }
      });

      // Combine date and time
      if (data.preferred_date && data.preferred_time) {
        data.preferred_viewing_date = `${data.preferred_date}T${data.preferred_time}:00`;
      }

      // Get API credentials from window
      const apiKey = import.meta.env.PUBLIC_STRATOS_API_KEY;
      const apiEndpoint = import.meta.env.PUBLIC_STRATOS_API_ENDPOINT;

      // Submit to Edge Function
      const response = await fetch(`${apiEndpoint}/enquiry`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-API-Key': apiKey,
        },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        throw new Error('Failed to submit enquiry');
      }

      // Show success message
      successDiv.style.display = 'block';
      form.reset();

      // Scroll to success message
      successDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

    } catch (error) {
      console.error('Form submission error:', error);
      errorDiv.textContent = 'There was an error submitting your request. Please try again or contact us directly.';
      errorDiv.style.display = 'block';
      
      // Re-enable submit button
      submitBtn.disabled = false;
      submitBtn.textContent = 'Request Viewing';
    }
  });
</script>