---
interface Props {
  property: any
  variant?: 'grid' | 'list'
}

const { property, variant = 'grid' } = Astro.props

const primaryImage = property.media?.[0]
const price = property.listing_type === 'sale' 
  ? `£${property.asking_price?.toLocaleString()}`
  : `£${property.rent_amount?.toLocaleString()}/${property.rent_frequency === 'weekly' ? 'pw' : 'pcm'}`

const bedBathText = [
  property.bedrooms ? `${property.bedrooms} bed` : null,
  property.bathrooms ? `${property.bathrooms} bath` : null,
].filter(Boolean).join(' • ')

const propertySlug = `${property.id}-${property.display_address?.toLowerCase().replace(/[^a-z0-9]+/g, '-')}`

// Check if price reduced
const priceReduced = property.previous_price && property.previous_price > (property.asking_price || property.rent_amount)
---


  href={`/properties/${propertySlug}`}
  class={`property-card block bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-xl transition-all duration-300 overflow-hidden group ${variant === 'list' ? 'flex' : ''}`}
  data-property-id={property.id}
>
  <!-- Image -->
  <div class={`relative ${variant === 'list' ? 'w-80 flex-shrink-0' : 'aspect-[4/3]'} overflow-hidden`}>
    {primaryImage ? (
      <img
        src={primaryImage.thumbnail_url || primaryImage.file_url}
        alt={property.display_address}
        class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
        loading="lazy"
      />
    ) : (
      <div class="w-full h-full bg-gray-200 flex items-center justify-center">
        <svg class="h-16 w-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
        </svg>
      </div>
    )}

    <!-- Badges -->
    <div class="absolute top-3 left-3 flex flex-col gap-2">
      {property.is_featured && (
        <span class="px-3 py-1 bg-yellow-500 text-white rounded-full text-xs font-bold">
          ⭐ Featured
        </span>
      )}
      {priceReduced && (
        <span class="px-3 py-1 bg-red-500 text-white rounded-full text-xs font-bold">
          Price Reduced
        </span>
      )}
      {property.listing_status === 'under_offer' && (
        <span class="px-3 py-1 bg-orange-500 text-white rounded-full text-xs font-bold">
          Under Offer
        </span>
      )}
      {property.listing_status === 'sold_subject_to_contract' && (
        <span class="px-3 py-1 bg-purple-500 text-white rounded-full text-xs font-bold">
          SSTC
        </span>
      )}
    </div>

    <!-- Image Count -->
    {property.media?.length > 1 && (
      <div class="absolute bottom-3 right-3 px-2 py-1 bg-black/70 text-white rounded text-xs font-medium flex items-center gap-1">
        <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        {property.media.length}
      </div>
    )}

    <!-- Save Button -->
    <button
      type="button"
      class="save-property-btn absolute top-3 right-3 w-10 h-10 bg-white/90 hover:bg-white rounded-full flex items-center justify-center transition-all shadow-lg"
      data-property-id={property.id}
      aria-label="Save property"
    >
      <svg class="h-5 w-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
      </svg>
    </button>
  </div>

  <!-- Content -->
  <div class={`p-4 ${variant === 'list' ? 'flex-1' : ''}`}>
    <!-- Price -->
    <div class="flex items-start justify-between mb-2">
      <div>
        <p class="text-2xl font-bold text-gray-900">{price}</p>
        {priceReduced && (
          <p class="text-sm text-gray-500 line-through">
            £{property.previous_price?.toLocaleString()}
          </p>
        )}
      </div>
      
      {property.price_qualifier && (
        <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs font-medium capitalize">
          {property.price_qualifier.replace('_', ' ')}
        </span>
      )}
    </div>

    <!-- Address -->
    <h3 class="font-semibold text-gray-900 mb-1 line-clamp-1 group-hover:text-[#064728] transition-colors">
      {property.display_address}
    </h3>
    
    <p class="text-sm text-gray-600 mb-3">
      {property.city}{property.county ? `, ${property.county}` : ''}
    </p>

    <!-- Property Details -->
    <div class="flex items-center gap-4 text-sm text-gray-600 mb-3">
      {property.bedrooms && (
        <span class="flex items-center gap-1">
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
          </svg>
          {property.bedrooms}
        </span>
      )}
      {property.bathrooms && (
        <span class="flex items-center gap-1">
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          {property.bathrooms}
        </span>
      )}
      {property.receptions && (
        <span class="flex items-center gap-1">
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
          {property.receptions}
        </span>
      )}
    </div>

    <!-- Property Type -->
    <p class="text-sm text-gray-600 capitalize mb-3">
      {property.property_type?.replace('_', ' ')}
      {property.property_style ? ` • ${property.property_style.replace('_', ' ')}` : ''}
    </p>

    <!-- Key Features (first 2) -->
    {property.key_features && property.key_features.length > 0 && (
      <div class="flex flex-wrap gap-1 mb-3">
        {property.key_features.slice(0, 2).map((feature: string) => (
          <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs capitalize">
            {feature.replace('_', ' ')}
          </span>
        ))}
        {property.key_features.length > 2 && (
          <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">
            +{property.key_features.length - 2} more
          </span>
        )}
      </div>
    )}

    <!-- Summary (list view only) -->
    {variant === 'list' && property.summary && (
      <p class="text-sm text-gray-600 line-clamp-2 mt-3">
        {property.summary}
      </p>
    )}

    <!-- EPC Rating -->
    {property.epc_rating && (
      <div class="flex items-center gap-2 mt-3">
        <span class="text-xs text-gray-600">EPC Rating:</span>
        <span class={`px-2 py-1 rounded text-xs font-bold ${
          ['A', 'B'].includes(property.epc_rating) ? 'bg-green-100 text-green-800' :
          ['C', 'D'].includes(property.epc_rating) ? 'bg-yellow-100 text-yellow-800' :
          'bg-red-100 text-red-800'
        }`}>
          {property.epc_rating}
        </span>
      </div>
    )}

    <!-- Listed Date -->
    <p class="text-xs text-gray-500 mt-3">
      Listed {new Date(property.listed_date || property.created_at).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}
    </p>
  </div>
</a>

<script>
  // Track property view on click
  document.querySelectorAll('.property-card').forEach(card => {
    card.addEventListener('click', () => {
      const propertyId = card.getAttribute('data-property-id')
      
      // Track event (using your existing tracker)
      if (window.StratosTracker) {
        window.StratosTracker.track('property_view', {
          property_id: propertyId
        })
      }
    })
  })

  // Save property functionality
  document.querySelectorAll('.save-property-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault()
      e.stopPropagation()
      
      const propertyId = btn.getAttribute('data-property-id')
      const svg = btn.querySelector('svg')
      
      // Toggle saved state
      const isSaved = btn.classList.contains('saved')
      
      if (isSaved) {
        btn.classList.remove('saved')
        svg?.setAttribute('fill', 'none')
        removeFromSaved(propertyId)
      } else {
        btn.classList.add('saved')
        svg?.setAttribute('fill', 'currentColor')
        addToSaved(propertyId)
      }
    })
  })

  function addToSaved(propertyId: string) {
    const saved = JSON.parse(localStorage.getItem('saved-properties') || '[]')
    if (!saved.includes(propertyId)) {
      saved.push(propertyId)
      localStorage.setItem('saved-properties', JSON.stringify(saved))
    }
  }

  function removeFromSaved(propertyId: string) {
    const saved = JSON.parse(localStorage.getItem('saved-properties') || '[]')
    const filtered = saved.filter((id: string) => id !== propertyId)
    localStorage.setItem('saved-properties', JSON.stringify(filtered))
  }

  // Mark already saved properties
  const saved = JSON.parse(localStorage.getItem('saved-properties') || '[]')
  saved.forEach((id: string) => {
    const btn = document.querySelector(`[data-property-id="${id}"].save-property-btn`)
    if (btn) {
      btn.classList.add('saved')
      btn.querySelector('svg')?.setAttribute('fill', 'currentColor')
    }
  })
</script>