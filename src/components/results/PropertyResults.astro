---
import ResultsHeader from './ResultsHeader.astro'
import PropertyGrid from './PropertyGrid.astro'
import PropertyList from './PropertyList.astro'
import PropertyMap from './PropertyMap.astro'
import Pagination from './Pagination.astro'
import SaveSearchButton from './SaveSearchButton.astro'

interface Props {
  results: {
    properties: any[]
    total: number
    page: number
    limit: number
    total_pages: number
    filters_applied: any
  }
  searchParams: any
}

const { results, searchParams } = Astro.props
---

<div class="property-results" data-total-properties={results.total}>
  <!-- Results Header -->
  <ResultsHeader 
    total={results.total}
    page={results.page}
    limit={results.limit}
    filters={results.filters_applied}
  />

  <!-- Save Search Button (if user is logged in) -->
  <div class="mb-6">
    <SaveSearchButton searchParams={searchParams} />
  </div>

  <!-- View Toggle & Sort Controls -->
  <div class="flex items-center justify-between mb-6">
    <!-- View Toggle -->
    <div class="flex items-center gap-2 bg-white rounded-lg border border-gray-200 p-1">
      <button
        type="button"
        data-view="grid"
        class="view-toggle-btn px-4 py-2 rounded-md text-sm font-medium transition-all bg-[#064728] text-white"
      >
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
        </svg>
      </button>
      <button
        type="button"
        data-view="list"
        class="view-toggle-btn px-4 py-2 rounded-md text-sm font-medium transition-all text-gray-600 hover:text-gray-900"
      >
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
      <button
        type="button"
        data-view="map"
        class="view-toggle-btn px-4 py-2 rounded-md text-sm font-medium transition-all text-gray-600 hover:text-gray-900"
      >
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
        </svg>
      </button>
    </div>

    <!-- Sort Dropdown -->
    <form method="GET" action="/properties/search" id="sort-form">
      <!-- Preserve all existing search params -->
      {Object.entries(searchParams).map(([key, value]) => (
        key !== 'sort_by' && key !== 'page' && (
          <input type="hidden" name={key} value={value} />
        )
      ))}
      
      <select
        name="sort"
        id="sort-select"
        class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#064728] focus:border-[#064728]"
      >
        <option value="newest" selected={searchParams.sort_by === 'newest'}>Newest listings</option>
        <option value="oldest" selected={searchParams.sort_by === 'oldest'}>Oldest listings</option>
        <option value="price_asc" selected={searchParams.sort_by === 'price_asc'}>Price (low to high)</option>
        <option value="price_desc" selected={searchParams.sort_by === 'price_desc'}>Price (high to low)</option>
        <option value="reduced" selected={searchParams.sort_by === 'reduced'}>Recently reduced</option>
      </select>
    </form>
  </div>

  <!-- Results Views -->
  <div id="grid-view" class="results-view block">
    <PropertyGrid properties={results.properties} />
  </div>

  <div id="list-view" class="results-view hidden">
    <PropertyList properties={results.properties} />
  </div>

  <div id="map-view" class="results-view hidden">
    <PropertyMap properties={results.properties} />
  </div>

  <!-- Pagination -->
  {results.total_pages > 1 && (
    <div class="mt-12">
      <Pagination 
        currentPage={results.page}
        totalPages={results.total_pages}
        searchParams={searchParams}
      />
    </div>
  )}
</div>

<script>
  // View toggle functionality
  const viewButtons = document.querySelectorAll('.view-toggle-btn')
  const views = document.querySelectorAll('.results-view')

  viewButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const viewType = btn.getAttribute('data-view')
      
      // Update button states
      viewButtons.forEach(b => {
        b.classList.remove('bg-[#064728]', 'text-white')
        b.classList.add('text-gray-600')
      })
      btn.classList.add('bg-[#064728]', 'text-white')
      btn.classList.remove('text-gray-600')

      // Show corresponding view
      views.forEach(view => {
        view.classList.add('hidden')
      })
      document.getElementById(`${viewType}-view`)?.classList.remove('hidden')

      // Save preference to localStorage
      localStorage.setItem('property-view-preference', viewType)
    })
  })

  // Restore view preference
  const savedView = localStorage.getItem('property-view-preference')
  if (savedView) {
    const btn = document.querySelector(`[data-view="${savedView}"]`)
    if (btn) {
      btn.click()
    }
  }

  // Auto-submit sort form
  const sortSelect = document.getElementById('sort-select')
  sortSelect?.addEventListener('change', () => {
    document.getElementById('sort-form')?.submit()
  })
</script>