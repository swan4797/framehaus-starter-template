---
interface Props {
  property: any
}

const { property } = Astro.props
---

<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
  <h3 class="text-xl font-bold text-gray-900 mb-4">Request a Viewing</h3>

  <form id="viewing-form" class="space-y-4">
    <input type="hidden" name="property_id" value={property.id} />
    
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
      <input
        type="text"
        name="name"
        required
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#064728] focus:border-[#064728]"
      />
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
      <input
        type="email"
        name="email"
        required
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#064728] focus:border-[#064728]"
      />
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
      <input
        type="tel"
        name="phone"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#064728] focus:border-[#064728]"
      />
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Preferred Date</label>
      <input
        type="date"
        name="preferred_date"
        min={new Date().toISOString().split('T')[0]}
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#064728] focus:border-[#064728]"
      />
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Preferred Time</label>
      <select
        name="preferred_time"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#064728] focus:border-[#064728]"
      >
        <option value="">Any time</option>
        <option value="morning">Morning (9am - 12pm)</option>
        <option value="afternoon">Afternoon (12pm - 5pm)</option>
        <option value="evening">Evening (5pm - 7pm)</option>
      </select>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
      <textarea
        name="message"
        rows="3"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#064728] focus:border-[#064728]"
        placeholder="Any specific requirements or questions?"
      ></textarea>
    </div>

    <div class="flex items-start">
      <input
        type="checkbox"
        name="marketing"
        id="marketing"
        class="mt-1 w-4 h-4 text-[#064728] border-gray-300 rounded focus:ring-[#064728]"
      />
      <label for="marketing" class="ml-2 text-sm text-gray-600">
        I'd like to receive property updates and market news by email
      </label>
    </div>

    <button
      type="submit"
      class="w-full px-6 py-3 bg-[#064728] text-white rounded-lg hover:bg-[#0a5c35] transition-colors font-medium flex items-center justify-center gap-2"
    >
      <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
      <span id="submit-text">Request Viewing</span>
    </button>
  </form>
</div>

<script>
  const form = document.getElementById('viewing-form')
  const submitText = document.getElementById('submit-text')
  const API_ENDPOINT = import.meta.env.PUBLIC_STRATOS_API_ENDPOINT
  const API_KEY = import.meta.env.PUBLIC_STRATOS_API_KEY
  const AGENCY_ID = import.meta.env.PUBLIC_AGENCY_ID

  form?.addEventListener('submit', async (e) => {
    e.preventDefault()

    const formData = new FormData(form as HTMLFormElement)
    const data = Object.fromEntries(formData.entries())

    // Disable button
    const button = form.querySelector('button[type="submit"]')
    button?.setAttribute('disabled', 'true')
    if (submitText) submitText.textContent = 'Submitting...'

    try {
      const response = await fetch(`${API_ENDPOINT}/submit-enquiry`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${API_KEY}`
        },
        body: JSON.stringify({
          agency_id: AGENCY_ID,
          enquiry_type: 'viewing_request',
          property_id: data.property_id,
          contact_name: data.name,
          contact_email: data.email,
          contact_phone: data.phone,
          message: data.message,
          marketing_opt_in: !!data.marketing,
          metadata: {
            preferred_date: data.preferred_date,
            preferred_time: data.preferred_time
          }
        })
      })

      if (response.ok) {
        // Success
        if (submitText) submitText.textContent = 'Request Sent! âœ“'
        button?.classList.remove('bg-[#064728]')
        button?.classList.add('bg-green-600')
        
        // Reset form
        form.reset()

        // Track conversion
        if (window.StratosTracker) {
          window.StratosTracker.track('viewing_request', {
            property_id: data.property_id
          })
        }
      } else {
        throw new Error('Failed to submit')
      }
    } catch (error) {
      if (submitText) submitText.textContent = 'Error - Please Try Again'
      button?.classList.add('bg-red-600')
    } finally {
      setTimeout(() => {
        button?.removeAttribute('disabled')
        if (submitText) submitText.textContent = 'Request Viewing'
        button?.classList.remove('bg-green-600', 'bg-red-600')
        button?.classList.add('bg-[#064728]')
      }, 3000)
    }
  })
</script>