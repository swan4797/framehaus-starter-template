---
// ========================================
// PROPERTY CARD COMPONENT
// Displays property summary in grid/list
// ========================================

import type { Property } from '../../types/database'
import {
  getPropertyUrl,
  getDisplayPrice,
  getThumbnailUrl,
  formatBedrooms,
  formatPropertyType,
  getStatusBadgeText,
  getStatusBadgeClass,
  formatRelativeDate,
} from '../../lib/utils'

interface Props {
  property: Property
  featured?: boolean
}

const { property, featured = false } = Astro.props

const propertyUrl = getPropertyUrl(property)
const displayPrice = getDisplayPrice(property)
const thumbnailUrl = getThumbnailUrl(property)
const bedrooms = formatBedrooms(property.bedrooms)
const propertyType = formatPropertyType(property.property_type)
const statusText = getStatusBadgeText(property.listing_status)
const statusClass = getStatusBadgeClass(property.listing_status)
const listedDate = property.listed_date ? formatRelativeDate(property.listed_date) : null
---

<article
  class:list={[
    'bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-shadow duration-300',
    { 'ring-2 ring-blue-500': featured }
  ]}
>
  <a href={propertyUrl} class="block group">
    <!-- Image -->
    <div class="relative h-64 bg-gray-200 overflow-hidden">
      <img
        src={thumbnailUrl}
        alt={property.display_address}
        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
        loading="lazy"
      />
      
      <!-- Featured Badge -->
      {featured && (
        <div class="absolute top-3 left-3 bg-blue-600 text-white text-xs font-semibold px-3 py-1 rounded-full">
          Featured
        </div>
      )}
      
      <!-- Status Badge -->
      {property.listing_status !== 'available' && (
        <div class:list={['absolute top-3 right-3 text-xs font-semibold px-3 py-1 rounded-full', statusClass]}>
          {statusText}
        </div>
      )}
      
      <!-- Listing Type Badge -->
      <div class="absolute bottom-3 left-3 bg-black bg-opacity-70 text-white text-xs font-medium px-3 py-1 rounded">
        For {property.listing_type === 'sale' ? 'Sale' : 'Rent'}
      </div>
    </div>

    <!-- Content -->
    <div class="p-5">
      <!-- Price -->
      <div class="mb-2">
        <span class="text-2xl font-bold text-gray-900">{displayPrice}</span>
      </div>

      <!-- Address -->
      <h3 class="text-lg font-semibold text-gray-900 mb-2 line-clamp-1 group-hover:text-blue-600 transition-colors">
        {property.display_address}
      </h3>

      <!-- Property Type -->
      <p class="text-sm text-gray-600 mb-3">
        {propertyType}
      </p>

      <!-- Features -->
      <div class="flex items-center gap-4 text-sm text-gray-700 mb-3">
        <!-- Bedrooms -->
        <div class="flex items-center gap-1">
          <svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
          </svg>
          <span>{property.bedrooms}</span>
        </div>

        <!-- Bathrooms -->
        {property.bathrooms > 0 && (
          <div class="flex items-center gap-1">
            <svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path>
            </svg>
            <span>{property.bathrooms}</span>
          </div>
        )}

        <!-- Receptions -->
        {property.receptions && property.receptions > 0 && (
          <div class="flex items-center gap-1">
            <svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
            </svg>
            <span>{property.receptions} reception{property.receptions > 1 ? 's' : ''}</span>
          </div>
        )}
      </div>

      <!-- Summary -->
      {property.summary && (
        <p class="text-sm text-gray-600 line-clamp-2 mb-3">
          {property.summary}
        </p>
      )}

      <!-- Footer -->
      <div class="flex items-center justify-between text-xs text-gray-500 pt-3 border-t border-gray-200">
        {listedDate && <span>Listed {listedDate}</span>}
        <span class="text-blue-600 font-medium group-hover:underline">View Details â†’</span>
      </div>
    </div>
  </a>
</article>

<style>
  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
<script define:vars={{ propertyId: property.id }}>
    document.querySelector('.property-card')?.addEventListener('click', () => {
      window.StratosTracker?.trackEvent('property_card_click', {
        property_id: propertyId,
      });
    });
</script>