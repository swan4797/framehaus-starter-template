---
// ========================================
// PROPERTY MAP LEAFLET - Integrated with Stratos Architecture
// Uses existing api.ts for fetching map data
// ========================================

import { api } from '../../lib/api'

interface Props {
  propertyId: string
  latitude?: number
  longitude?: number
  address?: string
  showDirections?: boolean
}

const { 
  propertyId, 
  latitude: propLat,
  longitude: propLng,
  address: propAddress,
  showDirections = true
} = Astro.props

// If lat/lng not provided, fetch from API
let mapData = null
let error = null

if (!propLat || !propLng) {
  try {
    const response = await api.getPropertyMapData(propertyId)

    if ('error' in response) {
      error = 'Failed to load map'
    } else {
      mapData = response.data
    }
  } catch (e) {
    error = 'Map unavailable'
    console.error('Map error:', e)
  }
}

const latitude = propLat || mapData?.coordinates?.latitude
const longitude = propLng || mapData?.coordinates?.longitude
const address = propAddress || mapData?.property?.address || 'Property location'
---

{(latitude && longitude) && (
  <div class="property-map-section">
    <h2 class="map-heading">
      üìç Location
    </h2>

    <div class="map-container">
      <!-- Leaflet Map -->
      <div id="property-map" class="leaflet-map" data-lat={latitude} data-lng={longitude}></div>

      <!-- Property Address -->
      <div class="map-info">
        <p class="address">
          <svg class="address-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
          <span>{address}</span>
        </p>

        {showDirections && (
          <div class="directions-links">
            <a 
              href={`https://www.google.com/maps?q=${latitude},${longitude}`}
              target="_blank" 
              rel="noopener noreferrer"
              class="directions-link"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 11l19-9-9 19-2-8-8-2z"></path>
              </svg>
              Get Directions
            </a>

            <a 
              href={`http://maps.apple.com/?q=${latitude},${longitude}`}
              target="_blank" 
              rel="noopener noreferrer"
              class="directions-link"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
              Apple Maps
            </a>
          </div>
        )}
      </div>
    </div>
  </div>
)}

{error && (
  <div class="map-error">
    <p>üìç Map temporarily unavailable</p>
  </div>
)}

<style>
  /* Styles remain the same as before... */
  .property-map-section {
    margin: 3rem 0;
  }

  .map-heading {
    font-size: 1.5rem;
    font-weight: 700;
    color: #111827;
    margin: 0 0 1.5rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .map-container {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
  }

  .leaflet-map {
    width: 100%;
    height: 400px;
  }

  /* ... rest of styles ... */
</style>

<script>
  import L from 'leaflet'
  import 'leaflet/dist/leaflet.css'

  // Fix Leaflet default marker icons
  import icon from 'leaflet/dist/images/marker-icon.png'
  import iconShadow from 'leaflet/dist/images/marker-shadow.png'

  const mapEl = document.getElementById('property-map')
  
  if (mapEl) {
    const lat = parseFloat(mapEl.dataset.lat || '0')
    const lng = parseFloat(mapEl.dataset.lng || '0')

    // Initialize map
    const map = L.map('property-map').setView([lat, lng], 15)

    // Add OpenStreetMap tiles (free!)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map)

    // Custom marker with brand color
    const customIcon = L.divIcon({
      className: 'custom-property-marker',
      html: `
        <div style="
          background: #3c5b4b;
          color: white;
          width: 40px;
          height: 40px;
          border-radius: 50% 50% 50% 0;
          transform: rotate(-45deg);
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 20px;
          border: 3px solid white;
          box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        ">
          <span style="transform: rotate(45deg); font-size: 20px;">üè†</span>
        </div>
      `,
      iconSize: [40, 40],
      iconAnchor: [20, 40]
    })

    // Add marker
    L.marker([lat, lng], { icon: customIcon }).addTo(map)

    console.log('üìç Property map initialized')
  }
</script>